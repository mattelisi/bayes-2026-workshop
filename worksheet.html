<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Matteo Lisi">

<title>Building and Customising Statistical Models with Stan and R: An Introduction to Bayesian Inference  Worksheet</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="worksheet_files/libs/clipboard/clipboard.min.js"></script>
<script src="worksheet_files/libs/quarto-html/quarto.js"></script>
<script src="worksheet_files/libs/quarto-html/popper.min.js"></script>
<script src="worksheet_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="worksheet_files/libs/quarto-html/anchor.min.js"></script>
<link href="worksheet_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="worksheet_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="worksheet_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="worksheet_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="worksheet_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#activity-1-mcmc-by-hand-with-metropolis-algorithm-simple-linear-regression" id="toc-activity-1-mcmc-by-hand-with-metropolis-algorithm-simple-linear-regression" class="nav-link active" data-scroll-target="#activity-1-mcmc-by-hand-with-metropolis-algorithm-simple-linear-regression">Activity 1 — MCMC “by hand” with Metropolis algorithm (simple linear regression)</a></li>
  <li><a href="#activity-2-linear-regression-in-stan" id="toc-activity-2-linear-regression-in-stan" class="nav-link" data-scroll-target="#activity-2-linear-regression-in-stan">Activity 2 — Linear regression in Stan</a></li>
  <li><a href="#activity-3-overdispersed-poisson-glmm" id="toc-activity-3-overdispersed-poisson-glmm" class="nav-link" data-scroll-target="#activity-3-overdispersed-poisson-glmm">Activity 3 — Overdispersed Poisson GLMM</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Building and Customising Statistical Models with Stan and R: An Introduction to Bayesian Inference<br> Worksheet</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Matteo Lisi </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="activity-1-mcmc-by-hand-with-metropolis-algorithm-simple-linear-regression" class="level2">
<h2 class="anchored" data-anchor-id="activity-1-mcmc-by-hand-with-metropolis-algorithm-simple-linear-regression">Activity 1 — MCMC “by hand” with Metropolis algorithm (simple linear regression)</h2>
<blockquote class="blockquote">
<p>Goal: Implement a bare-bones Metropolis sampler for a straight-line model on one participant from <code>sleepstudy</code>. Inspect priors, define the log-likelihood and (unnormalized) log-posterior, write a simple random-walk proposal, run the chain, and compare to least-squares.</p>
</blockquote>
<section id="setup" class="level4">
<h4 class="anchored" data-anchor-id="setup">Setup</h4>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" data-cap-location="margin"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Packages used here</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4) <span class="co"># for the sleepstudy data</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Pick example subject and plot their data</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(sleepstudy[sleepstudy<span class="sc">$</span>Subject <span class="sc">==</span> <span class="st">"308"</span>,],</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Days, Reaction, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">main =</span> <span class="st">"Subject 308"</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="at">xlab =</span> <span class="st">"Days of sleep deprivation"</span>, <span class="at">ylab =</span> <span class="st">"Reaction time (ms)"</span>,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">11</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">200</span>, <span class="dv">500</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="worksheet_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="384"></p>
</figure>
</div>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" data-cap-location="margin"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save vectors for the model code below</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> sleepstudy<span class="sc">$</span>Days[ sleepstudy<span class="sc">$</span>Subject <span class="sc">==</span> <span class="st">"308"</span> ]</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> sleepstudy<span class="sc">$</span>Reaction[ sleepstudy<span class="sc">$</span>Subject <span class="sc">==</span> <span class="st">"308"</span> ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="log-likelihood" class="level5">
<h5 class="anchored" data-anchor-id="log-likelihood">1) Log-likelihood</h5>
<p>The model is:<span class="math display">\[y_i \sim \mathcal{N}(\alpha + \beta x_i, \sigma_{\epsilon}^2)\]</span></p>
<p>Where <span class="math inline">\(\alpha\)</span> is the intercept, and <span class="math inline">\(\beta\)</span> the slope. We will work with <span class="math inline">\(\log \sigma_{\epsilon}\)</span> as the third parameter for stability (and so that we don’t need to worry about the lower boundary at zero).</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># par = c(intercept, slope, log_sigma)</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>loglik <span class="ot">&lt;-</span> <span class="cf">function</span>(par){</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> par[<span class="dv">1</span>] <span class="sc">+</span> par[<span class="dv">2</span>] <span class="sc">*</span> x</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(<span class="fu">dnorm</span>(y, <span class="at">mean =</span> pred, <span class="at">sd =</span> <span class="fu">exp</span>(par[<span class="dv">3</span>]), <span class="at">log =</span> <span class="cn">TRUE</span>))</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="priors-and-a-quick-visual-check" class="level5">
<h5 class="anchored" data-anchor-id="priors-and-a-quick-visual-check">2) Priors (and a quick visual check)</h5>
<p>We use an informative prior, as there is relevant prior knowledge that we can rely on (e.g.&nbsp;that average simple reaction times in humans tend to be around 250 ms): - <span class="math inline">\(\alpha \sim \mathcal{N} (250, 180^2)\)</span> - <span class="math inline">\(\beta \sim \mathcal{N} (20, 20^2)\)</span> - <span class="math inline">\(\log \sigma_{\epsilon} \sim \mathcal{N} (4, 1^2)\)</span></p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>logprior <span class="ot">&lt;-</span> <span class="cf">function</span>(par){</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dnorm</span>(par[<span class="dv">1</span>], <span class="at">mean =</span> <span class="dv">250</span>, <span class="at">sd =</span> <span class="dv">180</span>, <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dnorm</span>(par[<span class="dv">2</span>], <span class="at">mean =</span> <span class="dv">20</span>, <span class="at">sd =</span> <span class="dv">20</span>, <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dnorm</span>(par[<span class="dv">3</span>], <span class="at">mean =</span> <span class="dv">4</span>, <span class="at">sd =</span> <span class="dv">1</span>, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Is it useful to visualise it: these are our <em>a prior</em> expectations about plausible parameter values.</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(op <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">no.readonly =</span> <span class="cn">TRUE</span>)); <span class="fu">on.exit</span>(<span class="fu">par</span>(op), <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">2</span>,<span class="dv">1</span>))</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">curve</span>(<span class="fu">dnorm</span>(x, <span class="at">mean =</span> <span class="dv">250</span>, <span class="at">sd =</span> <span class="dv">180</span>), <span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">1000</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="at">xlab =</span> <span class="st">"Intercept"</span>, <span class="at">ylab =</span> <span class="st">"prior density"</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">curve</span>(<span class="fu">dnorm</span>(x, <span class="at">mean =</span> <span class="dv">20</span>, <span class="at">sd =</span> <span class="dv">20</span>), <span class="at">from =</span> <span class="sc">-</span><span class="dv">50</span>, <span class="at">to =</span> <span class="dv">50</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="at">xlab =</span> <span class="st">"Slope"</span>, <span class="at">ylab =</span> <span class="st">"prior density"</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>xx <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">6</span>, <span class="at">length.out =</span> <span class="dv">500</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>yy <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(xx, <span class="at">mean =</span> <span class="dv">4</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">exp</span>(xx), yy, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">xlab =</span> <span class="fu">expression</span>(sigma[epsilon]),</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="at">ylab =</span> <span class="st">"prior density"</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="worksheet_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="864"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="unnormalized-log-posterior" class="level5">
<h5 class="anchored" data-anchor-id="unnormalized-log-posterior">3) Unnormalized log-posterior</h5>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>logposterior <span class="ot">&lt;-</span> <span class="cf">function</span>(par){</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">loglik</span>(par) <span class="sc">+</span> <span class="fu">logprior</span>(par)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="random-walk-proposal" class="level5">
<h5 class="anchored" data-anchor-id="random-walk-proposal">4) Random-walk proposal</h5>
<p>We use a diagonal Gaussian proposal with tunable step sizes.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>proposal_sd <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">15</span>, <span class="dv">5</span>, <span class="fl">0.2</span>) <span class="co"># try tweaking these later</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  proposalfunction <span class="ot">&lt;-</span> <span class="cf">function</span>(par){</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rnorm</span>(<span class="dv">3</span>, <span class="at">mean =</span> par, <span class="at">sd =</span> proposal_sd)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="metropolis-sampler" class="level5">
<h5 class="anchored" data-anchor-id="metropolis-sampler">5) Metropolis sampler</h5>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>run_metropolis_MCMC <span class="ot">&lt;-</span> <span class="cf">function</span>(startvalue, iterations){</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set up an empty array to store sampled values</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  chain <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="at">dim =</span> <span class="fu">c</span>(iterations<span class="sc">+</span><span class="dv">1</span>,<span class="dv">3</span>))</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># put starting values at top of arrays</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  chain[<span class="dv">1</span>,] <span class="ot">&lt;-</span> startvalue</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>iterations){</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># draw a random proposal</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    proposal <span class="ot">&lt;-</span> <span class="fu">proposalfunction</span>(chain[i,])</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ratio of posterior density between new and old values</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">logposterior</span>(proposal) <span class="sc">-</span> <span class="fu">logposterior</span>(chain[i,]))</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sample random number &amp; accept/reject the parameter values</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;</span> a){</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>      chain[i<span class="sc">+</span><span class="dv">1</span>,] <span class="ot">&lt;-</span> proposal</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>      chain[i<span class="sc">+</span><span class="dv">1</span>,] <span class="ot">&lt;-</span> chain[i,]</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(chain)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="run-and-visualize" class="level5">
<h5 class="anchored" data-anchor-id="run-and-visualize">6) Run and visualize</h5>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Settings</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>startvalue <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">250</span>, <span class="dv">20</span>, <span class="dv">5</span>) <span class="co"># c(intercept, slope, log_sigma)</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>iterations <span class="ot">&lt;-</span> <span class="dv">20000</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Run chain</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>chain <span class="ot">&lt;-</span> <span class="fu">run_metropolis_MCMC</span>(startvalue, iterations)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Quick diagnostics and LS reference</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>burnIn <span class="ot">&lt;-</span> <span class="dv">3000</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>acceptance <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">mean</span>(<span class="fu">duplicated</span>(chain[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>burnIn), ]))</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>LSfit <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>interceptLS <span class="ot">&lt;-</span> <span class="fu">coef</span>(LSfit)[<span class="dv">1</span>]</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>slopeLS <span class="ot">&lt;-</span> <span class="fu">coef</span>(LSfit)[<span class="dv">2</span>]</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>sigmaLS <span class="ot">&lt;-</span> <span class="fu">summary</span>(LSfit)<span class="sc">$</span>sigma</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Plots</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>))</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(chain[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>burnIn), <span class="dv">1</span>], <span class="at">main =</span> <span class="st">"Intercept"</span>, <span class="at">border =</span> <span class="st">"white"</span>,</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="at">col =</span> <span class="st">"dark grey"</span>, <span class="at">breaks =</span> <span class="dv">20</span>)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> interceptLS, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(chain[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>burnIn), <span class="dv">2</span>], <span class="at">main =</span> <span class="st">"Slope"</span>, <span class="at">border =</span> <span class="st">"white"</span>,</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="at">col =</span> <span class="st">"dark grey"</span>, <span class="at">breaks =</span> <span class="dv">20</span>)</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> slopeLS, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">exp</span>(chain[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>burnIn), <span class="dv">3</span>]), <span class="at">main =</span> <span class="fu">expression</span>(sigma[epsilon]),</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="at">border =</span> <span class="st">"white"</span>, <span class="at">col =</span> <span class="st">"dark grey"</span>, <span class="at">breaks =</span> <span class="dv">20</span>)</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> sigmaLS, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(chain[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>burnIn), <span class="dv">1</span>], <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">main =</span> <span class="st">"Chain values: intercept"</span>)</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> interceptLS, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(chain[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>burnIn), <span class="dv">2</span>], <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">main =</span> <span class="st">"Chain values: slope"</span>)</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> slopeLS, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">exp</span>(chain[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>burnIn), <span class="dv">3</span>]), <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">main =</span> <span class="st">"Chain values: sigma"</span>)</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> sigmaLS, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="worksheet_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="summaries-credible-interval-for-slope" class="level5">
<h5 class="anchored" data-anchor-id="summaries-credible-interval-for-slope">7) Summaries (credible interval for slope)</h5>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove initial burn-in</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>burnIn <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>slope_samples <span class="ot">&lt;-</span> chain[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>burnIn), <span class="dv">2</span>]</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior mean</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(slope_samples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 21.48664</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% credible interval (percentile method)</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">c</span>(<span class="fu">quantile</span>(slope_samples, <span class="at">probs =</span> alpha<span class="sc">/</span><span class="dv">2</span>),</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(slope_samples, <span class="at">probs =</span> <span class="dv">1</span> <span class="sc">-</span> alpha<span class="sc">/</span><span class="dv">2</span>)), <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> 2.5% 97.5% 
11.73 31.88 </code></pre>
</div>
</div>
</section>
</section>
<section id="further-task" class="level4">
<h4 class="anchored" data-anchor-id="further-task">Further task</h4>
<p>Experiment by changing the priors and the proposal distribution, then run the sampler again. Observe how these changes affect convergence, acceptance rate, and the shape and location of the posterior distributions.</p>
</section>
</section>
<section id="activity-2-linear-regression-in-stan" class="level2">
<h2 class="anchored" data-anchor-id="activity-2-linear-regression-in-stan">Activity 2 — Linear regression in Stan</h2>
<blockquote class="blockquote">
<p>Goal: Fit a no-intercept Bayesian linear regression to the Hubble data in Stan, check convergence, summarize the posterior for β and σ, and then transform the posterior for β into a posterior for the age of the universe (in billions of years). Finally, visualize uncertainty both on the parameter and data scales.</p>
</blockquote>
<section id="setup-1" class="level4">
<h4 class="anchored" data-anchor-id="setup-1">Setup</h4>
<p>Load data</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/hubble.csv"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   24 obs. of  3 variables:
 $ Galaxy  : chr  "NGC0300" "NGC0925" "NGC1326A" "NGC1365" ...
 $ velocity: int  133 664 1794 1594 1473 278 714 882 80 772 ...
 $ distance: num  2 9.16 16.14 17.95 21.88 ...</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>    Galaxy velocity distance
1  NGC0300      133     2.00
2  NGC0925      664     9.16
3 NGC1326A     1794    16.14
4  NGC1365     1594    17.95
5  NGC1425     1473    21.88
6  NGC2403      278     3.22</code></pre>
</div>
</div>
<p>Quick plot</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18" data-cap-location="margin"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(d<span class="sc">$</span>distance, d<span class="sc">$</span>velocity,</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Distance [Mpc]"</span>, <span class="at">ylab=</span><span class="st">"Velocity [km/s]"</span>,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch=</span><span class="dv">19</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="worksheet_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<section id="stan-code" class="level5">
<h5 class="anchored" data-anchor-id="stan-code">1) Stan code</h5>
<p>Saved in the repository as <code>stan_code/hubble_model.stan</code></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; N;</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] distance;   <span class="co">// Mpc</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] velocity;   <span class="co">// km/s</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; beta;   <span class="co">// (km/s)/Mpc</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma;  <span class="co">// km/s</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// weakly-informative half-normal style via &lt;lower=0&gt;</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  beta  ~ normal(<span class="dv">0</span>, <span class="dv">200</span>);</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  sigma ~ normal(<span class="dv">0</span>, <span class="dv">2000</span>);</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  velocity ~ normal(beta * distance, sigma);</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="preparing-data-for-modelling-in-stan" class="level5">
<h5 class="anchored" data-anchor-id="preparing-data-for-modelling-in-stan">2) Preparing data for modelling in Stan</h5>
<p>We prepare data as list, and include also the number of observations <code>N</code>, which is needed in Stan to declare the size of data vectors.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">nrow</span>(d),</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">distance =</span> d<span class="sc">$</span>distance,  <span class="co"># Mpc</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">velocity =</span> d<span class="sc">$</span>velocity   <span class="co"># km/s</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(stan_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ N       : int 24
 $ distance: num [1:24] 2 9.16 16.14 17.95 21.88 ...
 $ velocity: int [1:24] 133 664 1794 1594 1473 278 714 882 80 772 ...</code></pre>
</div>
</div>
</section>
<section id="fit-the-model-and-check-convergence" class="level5">
<h5 class="anchored" data-anchor-id="fit-the-model-and-check-convergence">3) Fit the model and check convergence</h5>
<p>Load <code>rstan</code> library and run sampling of posterior</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> <span class="fu">max</span>(<span class="dv">1</span>, parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"stan_code/hubble_model.stan"</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>,</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Extract the posterior samples, and store them in a database format using the <code>tidybayes</code> package</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>posterior_samples <span class="ot">&lt;-</span> fit <span class="sc">%&gt;%</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(beta) </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(posterior_samples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  .chain .iteration .draw  beta
   &lt;int&gt;      &lt;int&gt; &lt;int&gt; &lt;dbl&gt;
1      1          1     1  67.8
2      1          2     2  77.0
3      1          3     3  78.2
4      1          4     4  78.4
5      1          5     5  74.6
6      1          6     6  80.9</code></pre>
</div>
</div>
<p>Examine results &amp; assess convergence</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"beta"</span>,<span class="st">"sigma"</span>), <span class="at">probs =</span> <span class="fu">c</span>(.<span class="dv">025</span>,.<span class="dv">5</span>,.<span class="dv">975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

        mean se_mean    sd   2.5%    50%  97.5% n_eff Rhat
beta   76.60    0.07  4.20  68.18  76.68  84.75  3210    1
sigma 273.99    0.86 42.65 207.16 268.62 369.71  2487    1

Samples were drawn using NUTS(diag_e) at Mon Nov 10 14:39:13 2025.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"beta"</span>,<span class="st">"sigma"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="worksheet_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="extract-posterior-draws-and-estimate-the-age-of-the-universe" class="level5">
<h5 class="anchored" data-anchor-id="extract-posterior-draws-and-estimate-the-age-of-the-universe">3) Extract posterior draws and estimate the age of the universe</h5>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>mpc_km <span class="ot">&lt;-</span> <span class="fl">3.09e19</span> <span class="co"># km per Megaparsec</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>sec_per_year <span class="ot">&lt;-</span> <span class="dv">60</span><span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="dv">24</span> <span class="sc">*</span> <span class="dv">365</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># transform in Km</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>hubble.const <span class="ot">&lt;-</span> posterior_samples<span class="sc">$</span>beta<span class="sc">/</span> mpc_km </span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co"># invert to get age in seconds</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>age <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>hubble.const</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co"># transform age in billion years</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>age <span class="ot">&lt;-</span> (age<span class="sc">/</span>sec_per_year) <span class="sc">/</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">9</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co"># point estimate</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(age)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 12.83049</code></pre>
</div>
</div>
<p>We can use a percentile method to determine a credibility interval</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% Bayesian credible interval</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">c</span>(<span class="fu">quantile</span>(age, <span class="at">probs =</span> alpha<span class="sc">/</span><span class="dv">2</span>),</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">quantile</span>(age, <span class="at">probs =</span> <span class="dv">1</span><span class="sc">-</span>alpha<span class="sc">/</span><span class="dv">2</span>)),</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">digits=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> 2.5% 97.5% 
11.56 14.37 </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Highest posterior density interval
</div>
</div>
<div class="callout-body-container callout-body">
<p>The percentile method works well in most cases but can be misleading for asymmetric posteriors, where for example the mode (the most probable value) may fall outside the interval. A highest posterior density (HPD, also referred to as HDI) interval is the shortest interval containing a specified proportion of the posterior mass. <em>Every point inside has higher probability density than any point outside.</em></p>
<p>In our example, the posterior for β is roughly symmetric, so percentile and HPD intervals are nearly identical.</p>
<p>Here is how we can compute this using the handy <code>tidybayes</code> package</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>fit <span class="sc">%&gt;%</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(beta) <span class="sc">%&gt;%</span> </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean_hdi</span>(beta, <span class="at">.width =</span> <span class="fl">0.95</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
   beta .lower .upper .width .point .interval
  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
1  76.6   67.5   84.1   0.95 mean   hdi      </code></pre>
</div>
</div>
<p>Or alternatively, computing the interval for more than one parameter at the same time:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>fit <span class="sc">%&gt;%</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather_draws</span>(beta, sigma) <span class="sc">%&gt;%</span>  </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(.variable) <span class="sc">%&gt;%</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean_hdi</span>(.value, <span class="at">.width =</span> <span class="fl">0.95</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 7
  .variable .value .lower .upper .width .point .interval
  &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
1 beta        76.6   67.5   84.1   0.95 mean   hdi      
2 sigma      274.   200.   359.    0.95 mean   hdi      </code></pre>
</div>
</div>
</div>
</div>
</section>
<section id="visualisation-of-uncertainty" class="level5">
<h5 class="anchored" data-anchor-id="visualisation-of-uncertainty">4) Visualisation of uncertainty</h5>
<p>Visualise posterior over the age of the universe as simple histogram</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36" data-cap-location="margin"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(age, <span class="at">breaks =</span><span class="dv">30</span>, <span class="at">xlab=</span><span class="st">"time (billions of years)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="worksheet_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>We can make this a bit nicer e.g.&nbsp;by adding smooth density curve and credible interval</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37" data-cap-location="margin"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get HDI interval</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>hdi <span class="ot">&lt;-</span> <span class="fu">mean_hdi</span>(age, <span class="at">.width =</span> <span class="fl">0.95</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute density</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>dens <span class="ot">&lt;-</span> <span class="fu">density</span>(age, <span class="at">adjust=</span><span class="dv">2</span>)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dens, <span class="at">main =</span> <span class="st">""</span>, <span class="at">xlab =</span> <span class="st">"time (billions of years)"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill inside HDI</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(dens<span class="sc">$</span>x[dens<span class="sc">$</span>x <span class="sc">&gt;=</span> hdi<span class="sc">$</span>ymin <span class="sc">&amp;</span> dens<span class="sc">$</span>x <span class="sc">&lt;=</span> hdi<span class="sc">$</span>ymax], hdi<span class="sc">$</span>ymax, hdi<span class="sc">$</span>ymin),</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(dens<span class="sc">$</span>y[dens<span class="sc">$</span>x <span class="sc">&gt;=</span> hdi<span class="sc">$</span>ymin <span class="sc">&amp;</span> dens<span class="sc">$</span>x <span class="sc">&lt;=</span> hdi<span class="sc">$</span>ymax], <span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">border =</span> <span class="cn">NA</span>)</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill outside HDI</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(dens<span class="sc">$</span>x[dens<span class="sc">$</span>x <span class="sc">&lt;</span> hdi<span class="sc">$</span>ymin], hdi<span class="sc">$</span>ymin, dens<span class="sc">$</span>x[<span class="dv">1</span>]),</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(dens<span class="sc">$</span>y[dens<span class="sc">$</span>x <span class="sc">&lt;</span> hdi<span class="sc">$</span>ymin], <span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="st">"gray90"</span>, <span class="at">border =</span> <span class="cn">NA</span>)</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(hdi<span class="sc">$</span>ymax, dens<span class="sc">$</span>x[dens<span class="sc">$</span>x <span class="sc">&gt;</span> hdi<span class="sc">$</span>ymax], <span class="fu">rev</span>(dens<span class="sc">$</span>x[dens<span class="sc">$</span>x <span class="sc">&gt;</span> hdi<span class="sc">$</span>ymax])[<span class="dv">1</span>]),</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(<span class="dv">0</span>, dens<span class="sc">$</span>y[dens<span class="sc">$</span>x <span class="sc">&gt;</span> hdi<span class="sc">$</span>ymax], <span class="dv">0</span>),</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="st">"gray90"</span>, <span class="at">border =</span> <span class="cn">NA</span>)</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Redraw density line on top</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(dens, <span class="at">lwd =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="worksheet_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>We can also visualise posterior samples as regression lines, to give a visual summary of the precision of model predictions</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38" data-cap-location="margin"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># basic plot</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(d<span class="sc">$</span>distance, d<span class="sc">$</span>velocity, <span class="at">xlab =</span> <span class="st">"Distance (Mpc)"</span>, <span class="at">ylab =</span> <span class="st">"Velocity (km/s)"</span>, <span class="at">pch =</span> <span class="dv">19</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># draw a subset of posterior lines</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">seq_along</span>(posterior_samples<span class="sc">$</span>beta), <span class="dv">500</span>)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> idx){</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> posterior_samples<span class="sc">$</span>beta[i], <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="fl">0.08</span>))</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="fu">median</span>(posterior_samples<span class="sc">$</span>beta), <span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co"># (redraw the points to prevent them being hidden by the lines)</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(d<span class="sc">$</span>distance, d<span class="sc">$</span>velocity, <span class="at">pch=</span><span class="dv">19</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="worksheet_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Using the “Generated quantities” block
</div>
</div>
<div class="callout-body-container callout-body">
<p>Stan models have also other types of block. One of them is the generated quantities block, which we can use to compute quantities of interest that depends on posterior parameters. in this block we can include also functions that simulates data, so it is useful for things such as <em>posterior predictive checks</em>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>stan_code <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; N;</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] distance; </span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] velocity; </span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; beta; </span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma;</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="st">  beta ~ normal(0, 200);</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="st">  sigma ~ normal(0, 2000);</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="st">  velocity ~ normal(beta * distance, sigma);</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="st">  real mpc_km; </span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a><span class="st">  real sec_per_year;</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a><span class="st">  mpc_km = 3.09 * 10^19;</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a><span class="st">  sec_per_year = 60^2 * 24 * 365;</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a><span class="st">  real age_universe = ((mpc_km / beta) / sec_per_year) / 1e9;</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_code =</span> stan_code,</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>,</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>)</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"beta"</span>,<span class="st">"sigma"</span>, <span class="st">"age_universe"</span>), <span class="at">probs =</span> <span class="fu">c</span>(.<span class="dv">025</span>,.<span class="dv">5</span>,.<span class="dv">975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

               mean se_mean    sd   2.5%    50%  97.5% n_eff Rhat
beta          76.50    0.08  4.18  68.36  76.55  84.63  2652    1
sigma        272.96    0.83 42.43 204.65 268.41 369.76  2614    1
age_universe  12.85    0.01  0.71  11.58  12.80  14.33  2593    1

Samples were drawn using NUTS(diag_e) at Mon Nov 10 14:48:30 2025.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="activity-3-overdispersed-poisson-glmm" class="level2">
<h2 class="anchored" data-anchor-id="activity-3-overdispersed-poisson-glmm">Activity 3 — Overdispersed Poisson GLMM</h2>
<blockquote class="blockquote">
<p>Goal: Model the rate of police stops across ethnic groups and precincts, adjusting for exposure (arrests) and allowing for <em>overdispersion</em> and <em>hierarchical structure</em>.</p>
</blockquote>
<ul>
<li><p><strong>Context:</strong> Study of the NYPD <em>stop-and-frisk</em> policy, investigating possible ethnic bias in police stops.</p></li>
<li><p><strong>Source:</strong> Records of ≈175,000 stops over 15 months (1998–1999), obtained by the New York State Attorney General’s Office.</p></li>
<li><p><strong>Variables:</strong></p>
<ul>
<li><code>stops</code> — Number of police stops recorded in 1998–1999 for the cell.</li>
<li><code>pop</code> — Estimated population size of the ethnic group within the precinct (exposure candidate).</li>
<li><code>past.arrests</code> — Number of 1997 arrests (DCJS) for the same group/crime category (proxy for crime exposure).</li>
<li><code>precinct</code> — Precinct ID (integers <strong>1–75</strong>).</li>
<li><code>eth</code> — Ethnicity code: <strong>1 = Black</strong>, <strong>2 = Hispanic</strong>, <strong>3 = White</strong>.</li>
<li><code>crime</code> — Crime category: <strong>1 = violent</strong>, <strong>2 = weapons</strong>, <strong>3 = property</strong>, <strong>4 = drug</strong>.</li>
</ul></li>
</ul>
<section id="setup-2" class="level4">
<h4 class="anchored" data-anchor-id="setup-2">Setup</h4>
<p>Load data into R</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(<span class="st">"data/police_stops.txt"</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>spc_tbl_ [900 × 6] (S3: spec_tbl_df/tbl_df/tbl/data.frame)
 $ stops       : num [1:900] 75 36 74 17 37 39 23 3 26 32 ...
 $ pop         : num [1:900] 1720 1720 1720 1720 1368 ...
 $ past.arrests: num [1:900] 191 57 599 133 62 27 149 57 135 16 ...
 $ precinct    : num [1:900] 1 1 1 1 1 1 1 1 1 1 ...
 $ eth         : num [1:900] 1 1 1 1 2 2 2 2 3 3 ...
 $ crime       : num [1:900] 1 2 3 4 1 2 3 4 1 2 ...
 - attr(*, "spec")=
  .. cols(
  ..   stops = col_double(),
  ..   pop = col_double(),
  ..   past.arrests = col_double(),
  ..   precinct = col_double(),
  ..   eth = col_double(),
  ..   crime = col_double()
  .. )
 - attr(*, "problems")=&lt;externalptr&gt; </code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a> <span class="fu">print</span>(d, <span class="at">n=</span><span class="dv">14</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 900 × 6
   stops   pop past.arrests precinct   eth crime
   &lt;dbl&gt; &lt;dbl&gt;        &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1    75  1720          191        1     1     1
 2    36  1720           57        1     1     2
 3    74  1720          599        1     1     3
 4    17  1720          133        1     1     4
 5    37  1368           62        1     2     1
 6    39  1368           27        1     2     2
 7    23  1368          149        1     2     3
 8     3  1368           57        1     2     4
 9    26 23854          135        1     3     1
10    32 23854           16        1     3     2
11    10 23854          107        1     3     3
12    13 23854          123        1     3     4
13    73  2596          227        2     1     1
14    37  2596           56        2     1     2
# ℹ 886 more rows</code></pre>
</div>
</div>
<p>We first add crime and stop counts over crime type (i.e.&nbsp;we are pooling together all crime types)</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(precinct, eth) <span class="sc">%&gt;%</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">stops =</span> <span class="fu">sum</span>(stops),</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">past.arrests =</span> <span class="fu">sum</span>(past.arrests),</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">pop =</span> <span class="fu">unique</span>(pop))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Compute summary statistics (averaging across the whole city).</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>d_summaries <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">eth =</span> <span class="fu">case_when</span>(</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    eth <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"black"</span>,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    eth <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"hispanic"</span>,</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    eth <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="st">"white"</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(eth) <span class="sc">%&gt;%</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop           =</span> <span class="fu">sum</span>(pop),</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_stops   =</span> <span class="fu">sum</span>(stops),</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_arrests =</span> <span class="fu">sum</span>(past.arrests),</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">prop_of_all_stops =</span> total_stops <span class="sc">/</span> <span class="fu">sum</span>(total_stops),</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_fraction      =</span> pop <span class="sc">/</span> <span class="fu">sum</span>(pop)</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>d_summaries</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 6
  eth          pop total_stops total_arrests prop_of_all_stops pop_fraction
  &lt;chr&gt;      &lt;dbl&gt;       &lt;dbl&gt;         &lt;dbl&gt;             &lt;dbl&gt;        &lt;dbl&gt;
1 black    1865895       69823        125719             0.531        0.275
2 hispanic 1732269       44623         74898             0.340        0.256
3 white    3175354       16974         35922             0.129        0.469</code></pre>
</div>
</div>
<section id="prepare-data-for-stan" class="level5">
<h5 class="anchored" data-anchor-id="prepare-data-for-stan">1) Prepare data for Stan</h5>
<p>Important: If <code>past.arrests == 0</code> for some rows but stops are nonzero, we need to avoid a zero Poisson mean. In this case however no adjustment is needed (otherwise we could have added a small constant, e.g.&nbsp;0.5, to zeroes in <code>past.arrests</code>)</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">any</span>(d<span class="sc">$</span>past.arrests <span class="sc">==</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">N         =</span> <span class="fu">nrow</span>(d),</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_eth     =</span> <span class="fu">length</span>(<span class="fu">unique</span>(d<span class="sc">$</span>eth)),</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_prec    =</span> <span class="fu">length</span>(<span class="fu">unique</span>(d<span class="sc">$</span>precinct)),</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">y         =</span> d<span class="sc">$</span>stops,</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">eth       =</span> d<span class="sc">$</span>eth,</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">past_arrests  =</span> d<span class="sc">$</span>past.arrests,</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">precinct  =</span> d<span class="sc">$</span>precinct</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(stan_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>List of 7
 $ N           : int 225
 $ n_eth       : int 3
 $ n_prec      : int 75
 $ y           : num [1:225] 202 102 81 132 144 71 752 441 410 385 ...
 $ eth         : num [1:225] 1 2 3 1 2 3 1 2 3 1 ...
 $ past_arrests: num [1:225] 980 295 381 753 557 ...
 $ precinct    : num [1:225] 1 1 1 2 2 2 3 3 3 4 ...</code></pre>
</div>
</div>
</section>
<section id="stan-code-1" class="level5">
<h5 class="anchored" data-anchor-id="stan-code-1">2) Stan code</h5>
<p>The code of the model is in the file <code>overdispersed_poisson.stan</code></p>
<div class="sourceCode" id="cb52"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; N;          <span class="co">// total # of (eth, precinct) data points</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; n_eth;      <span class="co">// number of ethnicity categories, e.g. 3</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; n_prec;     <span class="co">// number of precincts</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; y[N];       <span class="co">// outcome counts y_{ep}</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] past_arrests;  <span class="co">// baseline/reference rate</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>, <span class="kw">upper</span>=n_eth&gt; eth[N];      <span class="co">// ethnicity ID for each row</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>, <span class="kw">upper</span>=n_prec&gt; precinct[N]; <span class="co">// precinct ID for each row</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Ethnicity effects (fixed)</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[n_eth] alpha; </span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Random intercepts for precinct</span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma_beta; </span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[n_prec] beta_raw;   <span class="co">// non-centered param for precinct</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Overdispersion</span></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma_eps;</span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] eps_raw;         <span class="co">// non-centered param for each (e,p) observation</span></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[n_prec] beta; </span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>  beta = sigma_beta * beta_raw;</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] eps;</span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>  eps = sigma_eps * eps_raw;</span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Priors</span></span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a>  alpha ~ normal(<span class="dv">0</span>, <span class="dv">5</span>);           </span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a>  sigma_beta ~ exponential(<span class="dv">1</span>);    </span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>  beta_raw ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a>  sigma_eps ~ exponential(<span class="dv">1</span>);     </span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a>  eps_raw ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Likelihood</span></span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a>    y[i] ~ poisson(past_arrests[i] * (<span class="fl">15.0</span> / <span class="fl">12.0</span>) * exp(alpha[eth[i]] + beta[precinct[i]] + eps[i]));</span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that we use a <em>non-centred</em> parametrisation for the random intercepts:</p>
<p><span class="math display">\[\beta_p = \sigma_\beta \;\beta_{\text{raw},p}, \qquad \beta_{\text{raw},p} \sim N(0,1),\]</span></p>
<p>instead of sampling <span class="math inline">\(\beta_p\)</span> directly from <span class="math inline">\(N(0,\sigma_\beta^2)\)</span>. This often improves sampling efficiency in hierarchical models. The same logic applies to (_{ep}).</p>
</section>
<section id="compile-and-run" class="level5">
<h5 class="anchored" data-anchor-id="compile-and-run">3) Compile and run</h5>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"stan_code/overdispersed_poisson.stan"</span>,</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>,</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can use the print method for a quick look at the results</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"sigma_beta"</span>, <span class="st">"sigma_eps"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

            mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat
alpha[1]   -0.72       0 0.08 -0.87 -0.77 -0.72 -0.67 -0.57  2731    1
alpha[2]   -0.70       0 0.08 -0.85 -0.75 -0.70 -0.65 -0.55  2713    1
alpha[3]   -1.21       0 0.08 -1.37 -1.27 -1.21 -1.16 -1.05  2852    1
sigma_beta  0.62       0 0.06  0.51  0.57  0.61  0.65  0.74  2156    1
sigma_eps   0.30       0 0.02  0.26  0.28  0.30  0.31  0.34  1542    1

Samples were drawn using NUTS(diag_e) at Mon Nov 10 16:14:09 2025.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>Here, <code>alpha</code> are the ethnic-group log-effects, <code>sigma_beta</code> is the precinct-level standard deviation, and <code>sigma_eps</code> is the observation-level overdispersion parameter.</p>
</section>
<section id="diagnostic-checks" class="level5">
<h5 class="anchored" data-anchor-id="diagnostic-checks">4) Diagnostic checks</h5>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Traceplots</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"sigma_beta"</span>, <span class="st">"sigma_eps"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="worksheet_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57" data-cap-location="margin"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Pairs plot for some key parameters</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"alpha[1]"</span>, <span class="st">"alpha[2]"</span>, <span class="st">"alpha[3]"</span>, <span class="st">"sigma_beta"</span>, <span class="st">"sigma_eps"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="worksheet_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="inference" class="level5">
<h5 class="anchored" data-anchor-id="inference">5) Inference</h5>
<p>We use <code>tidybayes</code> to extract samples and summarize. Suppose we want to look at the exponentiated ethnic effects (relative stops vs.&nbsp;arrests).</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>posterior <span class="ot">&lt;-</span> fit <span class="sc">%&gt;%</span> </span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(alpha[e]) <span class="sc">%&gt;%</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rate =</span> <span class="fu">exp</span>(alpha))  <span class="co"># exponentiate to interpret as a multiplicative factor</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the rate by ethnicity</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>posterior <span class="sc">%&gt;%</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(e) <span class="sc">%&gt;%</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean_hdi</span>(rate, <span class="at">.width =</span> <span class="fl">0.95</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 7
      e  rate .lower .upper .width .point .interval
  &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
1     1 0.489  0.415  0.565   0.95 mean   hdi      
2     2 0.499  0.429  0.581   0.95 mean   hdi      
3     3 0.298  0.251  0.344   0.95 mean   hdi      </code></pre>
</div>
</div>
<p>If <code>e=1</code> = black, <code>e=2</code> = hispanic, <code>e=3</code> = white, these give the average ratio of stops to arrests for each ethnicity, accounting for precinct and overdispersion.</p>
<p>You might then compare black vs.&nbsp;white, etc., by calculating differences or ratios in the posterior draws.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>posterior_ratios <span class="ot">&lt;-</span> posterior <span class="sc">%&gt;%</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> <span class="fu">c</span>(.chain, .iteration, .draw),  <span class="co"># these 3 columns identify each draw</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> e,                          <span class="co"># which column to pivot on</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> rate,                      <span class="co"># which column holds the values</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_prefix =</span> <span class="st">"eth_"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">black_vs_white =</span> eth_1 <span class="sc">/</span> eth_3,</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">hisp_vs_white  =</span> eth_2 <span class="sc">/</span> eth_3) <span class="sc">%&gt;%</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Pivot longer so each ratio is in its own row</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(black_vs_white, hisp_vs_white),</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"contrast"</span>,</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"ratio"</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Summarize with mean_hdi -&gt; returns columns .mean, .lower, .upper</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(contrast) <span class="sc">%&gt;%</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean_hdi</span>(ratio, <span class="at">.width =</span> <span class="fl">0.95</span>)</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>posterior_ratios</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 7
  contrast       ratio .lower .upper .width .point .interval
  &lt;chr&gt;          &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
1 black_vs_white  1.65   1.48   1.80   0.95 mean   hdi      
2 hisp_vs_white   1.68   1.51   1.84   0.95 mean   hdi      </code></pre>
</div>
</div>
<p>This gives an estimate of how many times more likely stops of black (or hispanic) are relative to stops of white people, after controlling for arrests, precinct differences, and overdispersion.</p>
<p>To visualise this with a plot:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62" data-cap-location="margin"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(posterior_ratios, <span class="fu">aes</span>(<span class="at">x =</span> contrast, <span class="at">y =</span> ratio)) <span class="sc">+</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size=</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="dv">1</span>, <span class="at">lty=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> .lower, <span class="at">ymax =</span> .upper), <span class="at">width =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Ratio relative to White"</span>,</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Ethnicity vs. White Stop Ratios"</span>,</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Points = posterior means; bars = 95% HDI"</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="worksheet_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="240"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="prior-predictive-check" class="level5">
<h5 class="anchored" data-anchor-id="prior-predictive-check">5) Prior predictive check</h5>
<p>To check that the prior is sensible, it can be useful to simulate the <em>prior predictive distribution</em> and compare it to the actual, observed data. This is defined as</p>
<p><span class="math display">\[p(y) =  \int p(y\mid \Theta) \ p( \Theta) d\Theta \]</span> where <span class="math inline">\(\Theta\)</span> indicate the parameters, in this case <span class="math inline">\(\Theta = \left\{ \alpha, \sigma_{\beta}, \sigma_{\epsilon} \right\}\)</span>.</p>
<p>In other words, we resample both observation-level over dispersion values, the precinct-specific random intercepts, as well as the poisson observations. This gives us a way to estimate the prior predictive distribution, which we can then compare to the actual data. Ideally, the observed data should lie well within the prior-predictive distribution, suggesting that our priors were adequate and not too informative.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(d)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>n_eth <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(d<span class="sc">$</span>eth))</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>n_prec <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(d<span class="sc">$</span>precinct))</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Decide how many draws from the prior to simulate</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>n_sims <span class="ot">&lt;-</span> <span class="dv">500</span>  </span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll store all simulated Y values in a single big vector</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="co"># so we can compare them to the observed distribution</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>all_prior_stops <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="dv">0</span>)</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)  <span class="co"># reproducibility</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_sims) {</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1) Sample the parameters from their priors</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>  alpha_draw <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_eth, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">5</span>) <span class="co"># alpha: one for each ethnicity</span></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>  sigma_beta_draw <span class="ot">&lt;-</span> <span class="fu">rexp</span>(<span class="dv">1</span>, <span class="at">rate =</span> <span class="dv">1</span>)</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>  beta_raw_draw <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_prec, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>  beta_draw <span class="ot">&lt;-</span> sigma_beta_draw <span class="sc">*</span> beta_raw_draw</span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>  sigma_eps_draw <span class="ot">&lt;-</span> <span class="fu">rexp</span>(<span class="dv">1</span>, <span class="at">rate =</span> <span class="dv">1</span>)          <span class="co"># Overdispersion</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>  eps_raw_draw <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>  eps_draw <span class="ot">&lt;-</span> sigma_eps_draw <span class="sc">*</span> eps_raw_draw</span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2) Generate y (stops) from Poisson for each observation i</span></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>  past_arrests_offset <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(d<span class="sc">$</span>past.arrests <span class="sc">==</span> <span class="dv">0</span>, <span class="fl">0.5</span>, d<span class="sc">$</span>past.arrests)</span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute the linear predictor for each row i</span></span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a>  lambda_vec <span class="ot">&lt;-</span> <span class="fu">numeric</span>(N)</span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(N)) {</span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a>    e <span class="ot">&lt;-</span> d<span class="sc">$</span>eth[i]</span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> d<span class="sc">$</span>precinct[i]</span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a>    lambda_vec[i] <span class="ot">&lt;-</span> alpha_draw[e] <span class="sc">+</span> beta_draw[p] <span class="sc">+</span> eps_draw[i]</span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Poisson means</span></span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a>  mu_vec <span class="ot">&lt;-</span> past_arrests_offset <span class="sc">*</span> (<span class="dv">15</span><span class="sc">/</span><span class="dv">12</span>) <span class="sc">*</span> <span class="fu">exp</span>(lambda_vec)</span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sample from Poisson</span></span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a>  y_sim <span class="ot">&lt;-</span> <span class="fu">rpois</span>(N, mu_vec)</span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3) Store in a big vector for later comparison</span></span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a>  all_prior_stops <span class="ot">&lt;-</span> <span class="fu">c</span>(all_prior_stops, y_sim)</span>
<span id="cb63-45"><a href="#cb63-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we have the number of ‘stops’ simulated from the prior, and we can compare with the empirical distribution:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64" data-cap-location="margin"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>observed_stops <span class="ot">&lt;-</span> d<span class="sc">$</span>stops</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>df_plot <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="fu">c</span>((observed_stops ), (all_prior_stops )),</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">type  =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Empirical"</span>, <span class="st">"Prior"</span>), <span class="fu">c</span>(<span class="fu">length</span>(observed_stops), <span class="fu">length</span>(all_prior_stops))))</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot densities</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_plot, <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> type)) <span class="sc">+</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"stops"</span>, <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Prior Predictive vs. Empirical Distribution (log scale)"</span>,</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Data Source"</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="worksheet_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="posterior-predictive-check" class="level5">
<h5 class="anchored" data-anchor-id="posterior-predictive-check">6) Posterior predictive check</h5>
<p>We can use a similar approach to compare the posterior distribution to the observed data. That is, we are comparing the data with the <em>posterior predictive distribution</em></p>
<p><span class="math display">\[p(y^{\text{rep}} \mid y) =  \int p(y^{\text{rep}} \mid \Theta) \ p( \Theta \mid y) d\Theta \]</span> It may be useful to not resample all of the random effects; in this case for example I decided to hold fixed the precinct-specific random intercepts, and to resample only the observation-level overdispersion values.</p>
<p>This allows me to compute a predictive interval for the stop rate in each precinct, which allows more granularity in the comparison between model and data.</p>
<p>There are different ways to do this, either via R (as in the prior predictive check above) or we can take advantage of the generated quantities block in Stan, and add the following to our model code:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="kw">generated quantities</span> {</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] log_lik; <span class="co">// Log-likelihood for each observation (for LOO-CV)</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> eps_rep; <span class="co">// random effects observation-level overdipersion</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N] <span class="dt">int</span> y_rep;</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compute log-likelihood for observed data    </span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>    log_lik[i] = poisson_lpmf(y[i] | past_arrests[i] * (<span class="fl">15.0</span> / <span class="fl">12.0</span>) * exp(alpha[eth[i]] + beta[precinct[i]] + eps[i]));</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Simulate replicated data from posterior predictive distribution</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>    eps_rep = sigma_eps * normal_rng(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>    y_rep[i] = poisson_rng(past_arrests[i] * (<span class="fl">15.0</span> / <span class="fl">12.0</span>) * exp(alpha[eth[i]] + beta[precinct[i]] + eps_rep));</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Assuming the code is saved in the file <code>stan_code/overdispersed_poisson_PPC.stan</code>, we then need to re-do the sampling:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"stan_code/overdispersed_poisson_PPC.stan"</span>,</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>,</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Once we have run that, we can extract the posterior predictive for each precinct, and plot them alongside the observed.</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67" data-cap-location="margin"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Map observation index -&gt; precinct</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>precinct_idx <span class="ot">&lt;-</span> d<span class="sc">$</span>precinct  <span class="co"># length N</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Observed precinct totals</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>obs_totals <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(precinct) <span class="sc">%&gt;%</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">obs_total =</span> <span class="fu">sum</span>(stops), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Exposure per precinct (for *rates* option)</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>exposure_by_precinct <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">expo =</span> past.arrests <span class="sc">*</span> (<span class="dv">15</span><span class="sc">/</span><span class="dv">12</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(precinct) <span class="sc">%&gt;%</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">exposure =</span> <span class="fu">sum</span>(expo), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Extract posterior predictive draws for y_rep[i]</span></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>yrep_long <span class="ot">&lt;-</span> fit <span class="sc">%&gt;%</span></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(y_rep[i]) <span class="sc">%&gt;%</span></span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">precinct =</span> precinct_idx[i])</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Aggregate to precinct totals per draw</span></span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>ppc_totals <span class="ot">&lt;-</span> yrep_long <span class="sc">%&gt;%</span></span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(.draw, precinct) <span class="sc">%&gt;%</span></span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">rep_total =</span> <span class="fu">sum</span>(y_rep), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 3a) (Totals) Summarise mean and 95% CI per precinct</span></span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a>ppc_totals_sum <span class="ot">&lt;-</span> ppc_totals <span class="sc">%&gt;%</span></span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(precinct) <span class="sc">%&gt;%</span></span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean_qi</span>(rep_total, <span class="at">.width =</span> <span class="fl">0.95</span>) <span class="sc">%&gt;%</span>    <span class="co"># columns: rep_total, .lower, .upper</span></span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb67-30"><a href="#cb67-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(obs_totals, <span class="at">by =</span> <span class="st">"precinct"</span>)</span>
<span id="cb67-31"><a href="#cb67-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-32"><a href="#cb67-32" aria-hidden="true" tabindex="-1"></a>ppc_totals_sum_ord <span class="ot">&lt;-</span> ppc_totals_sum <span class="sc">%&gt;%</span></span>
<span id="cb67-33"><a href="#cb67-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">precinct_ord =</span> <span class="fu">fct_reorder</span>(<span class="fu">factor</span>(precinct), obs_total))</span>
<span id="cb67-34"><a href="#cb67-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-35"><a href="#cb67-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-36"><a href="#cb67-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 4a) Plot totals: posterior predictive (mean + 95% CI) vs observed</span></span>
<span id="cb67-37"><a href="#cb67-37" aria-hidden="true" tabindex="-1"></a>ppc_totals_sum <span class="sc">%&gt;%</span></span>
<span id="cb67-38"><a href="#cb67-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">precinct =</span> <span class="fu">fct_reorder</span>(<span class="fu">factor</span>(precinct), obs_total)) <span class="sc">%&gt;%</span></span>
<span id="cb67-39"><a href="#cb67-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(precinct), <span class="at">y =</span> rep_total)) <span class="sc">+</span></span>
<span id="cb67-40"><a href="#cb67-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> .lower, <span class="at">ymax =</span> .upper), <span class="at">color=</span><span class="st">"dark grey"</span>) <span class="sc">+</span></span>
<span id="cb67-41"><a href="#cb67-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> obs_total), <span class="at">shape =</span> <span class="dv">4</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.15</span>)) <span class="sc">+</span></span>
<span id="cb67-42"><a href="#cb67-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Precinct"</span>, <span class="at">y =</span> <span class="st">"Total stops"</span>,</span>
<span id="cb67-43"><a href="#cb67-43" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Posterior predictive totals by precinct"</span>,</span>
<span id="cb67-44"><a href="#cb67-44" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Points = posterior mean (CI = 95%), X = observed total"</span>) <span class="sc">+</span></span>
<span id="cb67-45"><a href="#cb67-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb67-46"><a href="#cb67-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="worksheet_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<!-- -->

</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb68" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Building and Customising Statistical Models with Stan and R: An Introduction to Bayesian Inference&lt;br&gt; Worksheet"</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Matteo Lisi"</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true     # run/copy buttons</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: show</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=FALSE, message=FALSE}</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a><span class="in">library(rstan)</span></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a><span class="in">library(lme4)</span></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a><span class="fu">## Activity 1 — MCMC "by hand" with Metropolis algorithm (simple linear regression)</span></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Goal: Implement a bare-bones Metropolis sampler for a straight-line model on one participant from </span><span class="in">`sleepstudy`</span><span class="at">. Inspect priors, define the log-likelihood and (unnormalized) log-posterior, write a simple random-walk proposal, run the chain, and compare to least-squares.</span></span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Setup</span></span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: 'center'</span></span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap-location: margin</span></span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 4</span></span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4.5</span></span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Packages used here</span></span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4) <span class="co"># for the sleepstudy data</span></span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Pick example subject and plot their data</span></span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(sleepstudy[sleepstudy<span class="sc">$</span>Subject <span class="sc">==</span> <span class="st">"308"</span>,],</span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Days, Reaction, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">main =</span> <span class="st">"Subject 308"</span>,</span>
<span id="cb68-45"><a href="#cb68-45" aria-hidden="true" tabindex="-1"></a><span class="at">xlab =</span> <span class="st">"Days of sleep deprivation"</span>, <span class="at">ylab =</span> <span class="st">"Reaction time (ms)"</span>,</span>
<span id="cb68-46"><a href="#cb68-46" aria-hidden="true" tabindex="-1"></a><span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">11</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">200</span>, <span class="dv">500</span>)))</span>
<span id="cb68-47"><a href="#cb68-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-48"><a href="#cb68-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-49"><a href="#cb68-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Save vectors for the model code below</span></span>
<span id="cb68-50"><a href="#cb68-50" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> sleepstudy<span class="sc">$</span>Days[ sleepstudy<span class="sc">$</span>Subject <span class="sc">==</span> <span class="st">"308"</span> ]</span>
<span id="cb68-51"><a href="#cb68-51" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> sleepstudy<span class="sc">$</span>Reaction[ sleepstudy<span class="sc">$</span>Subject <span class="sc">==</span> <span class="st">"308"</span> ]</span>
<span id="cb68-52"><a href="#cb68-52" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-53"><a href="#cb68-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-54"><a href="#cb68-54" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 1) Log-likelihood</span></span>
<span id="cb68-55"><a href="#cb68-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-56"><a href="#cb68-56" aria-hidden="true" tabindex="-1"></a>The model is:$$y_i \sim \mathcal{N}(\alpha + \beta x_i, \sigma_{\epsilon}^2)$$</span>
<span id="cb68-57"><a href="#cb68-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-58"><a href="#cb68-58" aria-hidden="true" tabindex="-1"></a>Where $\alpha$ is the intercept, and $\beta$ the slope. We will work with $\log \sigma_{\epsilon}$ as the third parameter for stability (and so that we don't need to worry about the lower boundary at zero).</span>
<span id="cb68-59"><a href="#cb68-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-62"><a href="#cb68-62" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-63"><a href="#cb68-63" aria-hidden="true" tabindex="-1"></a><span class="co"># par = c(intercept, slope, log_sigma)</span></span>
<span id="cb68-64"><a href="#cb68-64" aria-hidden="true" tabindex="-1"></a>loglik <span class="ot">&lt;-</span> <span class="cf">function</span>(par){</span>
<span id="cb68-65"><a href="#cb68-65" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> par[<span class="dv">1</span>] <span class="sc">+</span> par[<span class="dv">2</span>] <span class="sc">*</span> x</span>
<span id="cb68-66"><a href="#cb68-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(<span class="fu">dnorm</span>(y, <span class="at">mean =</span> pred, <span class="at">sd =</span> <span class="fu">exp</span>(par[<span class="dv">3</span>]), <span class="at">log =</span> <span class="cn">TRUE</span>))</span>
<span id="cb68-67"><a href="#cb68-67" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-68"><a href="#cb68-68" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-69"><a href="#cb68-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-70"><a href="#cb68-70" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 2) Priors (and a quick visual check)</span></span>
<span id="cb68-71"><a href="#cb68-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-72"><a href="#cb68-72" aria-hidden="true" tabindex="-1"></a>We use an informative prior, as there is relevant prior knowledge that we can rely on (e.g. that average simple reaction times in humans tend to be around 250 ms):</span>
<span id="cb68-73"><a href="#cb68-73" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\alpha \sim \mathcal{N} (250, 180^2)$</span>
<span id="cb68-74"><a href="#cb68-74" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\beta \sim \mathcal{N} (20, 20^2)$</span>
<span id="cb68-75"><a href="#cb68-75" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\log \sigma_{\epsilon} \sim \mathcal{N} (4, 1^2)$</span>
<span id="cb68-76"><a href="#cb68-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-77"><a href="#cb68-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-80"><a href="#cb68-80" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-81"><a href="#cb68-81" aria-hidden="true" tabindex="-1"></a>logprior <span class="ot">&lt;-</span> <span class="cf">function</span>(par){</span>
<span id="cb68-82"><a href="#cb68-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dnorm</span>(par[<span class="dv">1</span>], <span class="at">mean =</span> <span class="dv">250</span>, <span class="at">sd =</span> <span class="dv">180</span>, <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb68-83"><a href="#cb68-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dnorm</span>(par[<span class="dv">2</span>], <span class="at">mean =</span> <span class="dv">20</span>, <span class="at">sd =</span> <span class="dv">20</span>, <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb68-84"><a href="#cb68-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dnorm</span>(par[<span class="dv">3</span>], <span class="at">mean =</span> <span class="dv">4</span>, <span class="at">sd =</span> <span class="dv">1</span>, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb68-85"><a href="#cb68-85" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-86"><a href="#cb68-86" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-87"><a href="#cb68-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-88"><a href="#cb68-88" aria-hidden="true" tabindex="-1"></a>Is it useful to visualise it: these are our _a prior_ expectations about plausible parameter values.</span>
<span id="cb68-89"><a href="#cb68-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-92"><a href="#cb68-92" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-93"><a href="#cb68-93" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: 'center'</span></span>
<span id="cb68-94"><a href="#cb68-94" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 9</span></span>
<span id="cb68-95"><a href="#cb68-95" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 3</span></span>
<span id="cb68-96"><a href="#cb68-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-97"><a href="#cb68-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-98"><a href="#cb68-98" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(op <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">no.readonly =</span> <span class="cn">TRUE</span>)); <span class="fu">on.exit</span>(<span class="fu">par</span>(op), <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb68-99"><a href="#cb68-99" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>), <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">2</span>,<span class="dv">1</span>))</span>
<span id="cb68-100"><a href="#cb68-100" aria-hidden="true" tabindex="-1"></a><span class="fu">curve</span>(<span class="fu">dnorm</span>(x, <span class="at">mean =</span> <span class="dv">250</span>, <span class="at">sd =</span> <span class="dv">180</span>), <span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">1000</span>,</span>
<span id="cb68-101"><a href="#cb68-101" aria-hidden="true" tabindex="-1"></a><span class="at">xlab =</span> <span class="st">"Intercept"</span>, <span class="at">ylab =</span> <span class="st">"prior density"</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb68-102"><a href="#cb68-102" aria-hidden="true" tabindex="-1"></a><span class="fu">curve</span>(<span class="fu">dnorm</span>(x, <span class="at">mean =</span> <span class="dv">20</span>, <span class="at">sd =</span> <span class="dv">20</span>), <span class="at">from =</span> <span class="sc">-</span><span class="dv">50</span>, <span class="at">to =</span> <span class="dv">50</span>,</span>
<span id="cb68-103"><a href="#cb68-103" aria-hidden="true" tabindex="-1"></a><span class="at">xlab =</span> <span class="st">"Slope"</span>, <span class="at">ylab =</span> <span class="st">"prior density"</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb68-104"><a href="#cb68-104" aria-hidden="true" tabindex="-1"></a>xx <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">6</span>, <span class="at">length.out =</span> <span class="dv">500</span>)</span>
<span id="cb68-105"><a href="#cb68-105" aria-hidden="true" tabindex="-1"></a>yy <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(xx, <span class="at">mean =</span> <span class="dv">4</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb68-106"><a href="#cb68-106" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">exp</span>(xx), yy, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">xlab =</span> <span class="fu">expression</span>(sigma[epsilon]),</span>
<span id="cb68-107"><a href="#cb68-107" aria-hidden="true" tabindex="-1"></a><span class="at">ylab =</span> <span class="st">"prior density"</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb68-108"><a href="#cb68-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-109"><a href="#cb68-109" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-110"><a href="#cb68-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-111"><a href="#cb68-111" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 3) Unnormalized log-posterior</span></span>
<span id="cb68-112"><a href="#cb68-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-115"><a href="#cb68-115" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-116"><a href="#cb68-116" aria-hidden="true" tabindex="-1"></a>logposterior <span class="ot">&lt;-</span> <span class="cf">function</span>(par){</span>
<span id="cb68-117"><a href="#cb68-117" aria-hidden="true" tabindex="-1"></a><span class="fu">loglik</span>(par) <span class="sc">+</span> <span class="fu">logprior</span>(par)</span>
<span id="cb68-118"><a href="#cb68-118" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-119"><a href="#cb68-119" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-120"><a href="#cb68-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-121"><a href="#cb68-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-122"><a href="#cb68-122" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 4) Random-walk proposal</span></span>
<span id="cb68-123"><a href="#cb68-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-124"><a href="#cb68-124" aria-hidden="true" tabindex="-1"></a>We use a diagonal Gaussian proposal with tunable step sizes.</span>
<span id="cb68-125"><a href="#cb68-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-128"><a href="#cb68-128" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-129"><a href="#cb68-129" aria-hidden="true" tabindex="-1"></a>proposal_sd <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">15</span>, <span class="dv">5</span>, <span class="fl">0.2</span>) <span class="co"># try tweaking these later</span></span>
<span id="cb68-130"><a href="#cb68-130" aria-hidden="true" tabindex="-1"></a>  proposalfunction <span class="ot">&lt;-</span> <span class="cf">function</span>(par){</span>
<span id="cb68-131"><a href="#cb68-131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rnorm</span>(<span class="dv">3</span>, <span class="at">mean =</span> par, <span class="at">sd =</span> proposal_sd)</span>
<span id="cb68-132"><a href="#cb68-132" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-133"><a href="#cb68-133" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-134"><a href="#cb68-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-135"><a href="#cb68-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-136"><a href="#cb68-136" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 5) Metropolis sampler</span></span>
<span id="cb68-137"><a href="#cb68-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-140"><a href="#cb68-140" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-141"><a href="#cb68-141" aria-hidden="true" tabindex="-1"></a>run_metropolis_MCMC <span class="ot">&lt;-</span> <span class="cf">function</span>(startvalue, iterations){</span>
<span id="cb68-142"><a href="#cb68-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-143"><a href="#cb68-143" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set up an empty array to store sampled values</span></span>
<span id="cb68-144"><a href="#cb68-144" aria-hidden="true" tabindex="-1"></a>  chain <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="at">dim =</span> <span class="fu">c</span>(iterations<span class="sc">+</span><span class="dv">1</span>,<span class="dv">3</span>))</span>
<span id="cb68-145"><a href="#cb68-145" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-146"><a href="#cb68-146" aria-hidden="true" tabindex="-1"></a>  <span class="co"># put starting values at top of arrays</span></span>
<span id="cb68-147"><a href="#cb68-147" aria-hidden="true" tabindex="-1"></a>  chain[<span class="dv">1</span>,] <span class="ot">&lt;-</span> startvalue</span>
<span id="cb68-148"><a href="#cb68-148" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-149"><a href="#cb68-149" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>iterations){</span>
<span id="cb68-150"><a href="#cb68-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-151"><a href="#cb68-151" aria-hidden="true" tabindex="-1"></a>    <span class="co"># draw a random proposal</span></span>
<span id="cb68-152"><a href="#cb68-152" aria-hidden="true" tabindex="-1"></a>    proposal <span class="ot">&lt;-</span> <span class="fu">proposalfunction</span>(chain[i,])</span>
<span id="cb68-153"><a href="#cb68-153" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-154"><a href="#cb68-154" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ratio of posterior density between new and old values</span></span>
<span id="cb68-155"><a href="#cb68-155" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">logposterior</span>(proposal) <span class="sc">-</span> <span class="fu">logposterior</span>(chain[i,]))</span>
<span id="cb68-156"><a href="#cb68-156" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-157"><a href="#cb68-157" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sample random number &amp; accept/reject the parameter values</span></span>
<span id="cb68-158"><a href="#cb68-158" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;</span> a){</span>
<span id="cb68-159"><a href="#cb68-159" aria-hidden="true" tabindex="-1"></a>      chain[i<span class="sc">+</span><span class="dv">1</span>,] <span class="ot">&lt;-</span> proposal</span>
<span id="cb68-160"><a href="#cb68-160" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb68-161"><a href="#cb68-161" aria-hidden="true" tabindex="-1"></a>      chain[i<span class="sc">+</span><span class="dv">1</span>,] <span class="ot">&lt;-</span> chain[i,]</span>
<span id="cb68-162"><a href="#cb68-162" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb68-163"><a href="#cb68-163" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb68-164"><a href="#cb68-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(chain)</span>
<span id="cb68-165"><a href="#cb68-165" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-166"><a href="#cb68-166" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-167"><a href="#cb68-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-168"><a href="#cb68-168" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 6) Run and visualize</span></span>
<span id="cb68-169"><a href="#cb68-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-172"><a href="#cb68-172" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-173"><a href="#cb68-173" aria-hidden="true" tabindex="-1"></a><span class="co"># Settings</span></span>
<span id="cb68-174"><a href="#cb68-174" aria-hidden="true" tabindex="-1"></a>startvalue <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">250</span>, <span class="dv">20</span>, <span class="dv">5</span>) <span class="co"># c(intercept, slope, log_sigma)</span></span>
<span id="cb68-175"><a href="#cb68-175" aria-hidden="true" tabindex="-1"></a>iterations <span class="ot">&lt;-</span> <span class="dv">20000</span></span>
<span id="cb68-176"><a href="#cb68-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-177"><a href="#cb68-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-178"><a href="#cb68-178" aria-hidden="true" tabindex="-1"></a><span class="co"># Run chain</span></span>
<span id="cb68-179"><a href="#cb68-179" aria-hidden="true" tabindex="-1"></a>chain <span class="ot">&lt;-</span> <span class="fu">run_metropolis_MCMC</span>(startvalue, iterations)</span>
<span id="cb68-180"><a href="#cb68-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-181"><a href="#cb68-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-182"><a href="#cb68-182" aria-hidden="true" tabindex="-1"></a><span class="co"># Quick diagnostics and LS reference</span></span>
<span id="cb68-183"><a href="#cb68-183" aria-hidden="true" tabindex="-1"></a>burnIn <span class="ot">&lt;-</span> <span class="dv">3000</span></span>
<span id="cb68-184"><a href="#cb68-184" aria-hidden="true" tabindex="-1"></a>acceptance <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">mean</span>(<span class="fu">duplicated</span>(chain[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>burnIn), ]))</span>
<span id="cb68-185"><a href="#cb68-185" aria-hidden="true" tabindex="-1"></a>LSfit <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x)</span>
<span id="cb68-186"><a href="#cb68-186" aria-hidden="true" tabindex="-1"></a>interceptLS <span class="ot">&lt;-</span> <span class="fu">coef</span>(LSfit)[<span class="dv">1</span>]</span>
<span id="cb68-187"><a href="#cb68-187" aria-hidden="true" tabindex="-1"></a>slopeLS <span class="ot">&lt;-</span> <span class="fu">coef</span>(LSfit)[<span class="dv">2</span>]</span>
<span id="cb68-188"><a href="#cb68-188" aria-hidden="true" tabindex="-1"></a>sigmaLS <span class="ot">&lt;-</span> <span class="fu">summary</span>(LSfit)<span class="sc">$</span>sigma</span>
<span id="cb68-189"><a href="#cb68-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-190"><a href="#cb68-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-191"><a href="#cb68-191" aria-hidden="true" tabindex="-1"></a><span class="co"># Plots</span></span>
<span id="cb68-192"><a href="#cb68-192" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>))</span>
<span id="cb68-193"><a href="#cb68-193" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(chain[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>burnIn), <span class="dv">1</span>], <span class="at">main =</span> <span class="st">"Intercept"</span>, <span class="at">border =</span> <span class="st">"white"</span>,</span>
<span id="cb68-194"><a href="#cb68-194" aria-hidden="true" tabindex="-1"></a><span class="at">col =</span> <span class="st">"dark grey"</span>, <span class="at">breaks =</span> <span class="dv">20</span>)</span>
<span id="cb68-195"><a href="#cb68-195" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> interceptLS, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb68-196"><a href="#cb68-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-197"><a href="#cb68-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-198"><a href="#cb68-198" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(chain[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>burnIn), <span class="dv">2</span>], <span class="at">main =</span> <span class="st">"Slope"</span>, <span class="at">border =</span> <span class="st">"white"</span>,</span>
<span id="cb68-199"><a href="#cb68-199" aria-hidden="true" tabindex="-1"></a><span class="at">col =</span> <span class="st">"dark grey"</span>, <span class="at">breaks =</span> <span class="dv">20</span>)</span>
<span id="cb68-200"><a href="#cb68-200" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> slopeLS, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb68-201"><a href="#cb68-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-202"><a href="#cb68-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-203"><a href="#cb68-203" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">exp</span>(chain[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>burnIn), <span class="dv">3</span>]), <span class="at">main =</span> <span class="fu">expression</span>(sigma[epsilon]),</span>
<span id="cb68-204"><a href="#cb68-204" aria-hidden="true" tabindex="-1"></a><span class="at">border =</span> <span class="st">"white"</span>, <span class="at">col =</span> <span class="st">"dark grey"</span>, <span class="at">breaks =</span> <span class="dv">20</span>)</span>
<span id="cb68-205"><a href="#cb68-205" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> sigmaLS, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb68-206"><a href="#cb68-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-207"><a href="#cb68-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-208"><a href="#cb68-208" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(chain[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>burnIn), <span class="dv">1</span>], <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">main =</span> <span class="st">"Chain values: intercept"</span>)</span>
<span id="cb68-209"><a href="#cb68-209" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> interceptLS, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb68-210"><a href="#cb68-210" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(chain[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>burnIn), <span class="dv">2</span>], <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">main =</span> <span class="st">"Chain values: slope"</span>)</span>
<span id="cb68-211"><a href="#cb68-211" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> slopeLS, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb68-212"><a href="#cb68-212" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">exp</span>(chain[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>burnIn), <span class="dv">3</span>]), <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">main =</span> <span class="st">"Chain values: sigma"</span>)</span>
<span id="cb68-213"><a href="#cb68-213" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> sigmaLS, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb68-214"><a href="#cb68-214" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-215"><a href="#cb68-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-216"><a href="#cb68-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-217"><a href="#cb68-217" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 7) Summaries (credible interval for slope)</span></span>
<span id="cb68-218"><a href="#cb68-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-221"><a href="#cb68-221" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-222"><a href="#cb68-222" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove initial burn-in</span></span>
<span id="cb68-223"><a href="#cb68-223" aria-hidden="true" tabindex="-1"></a>burnIn <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb68-224"><a href="#cb68-224" aria-hidden="true" tabindex="-1"></a>slope_samples <span class="ot">&lt;-</span> chain[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>burnIn), <span class="dv">2</span>]</span>
<span id="cb68-225"><a href="#cb68-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-226"><a href="#cb68-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-227"><a href="#cb68-227" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior mean</span></span>
<span id="cb68-228"><a href="#cb68-228" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(slope_samples)</span>
<span id="cb68-229"><a href="#cb68-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-230"><a href="#cb68-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-231"><a href="#cb68-231" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% credible interval (percentile method)</span></span>
<span id="cb68-232"><a href="#cb68-232" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb68-233"><a href="#cb68-233" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">c</span>(<span class="fu">quantile</span>(slope_samples, <span class="at">probs =</span> alpha<span class="sc">/</span><span class="dv">2</span>),</span>
<span id="cb68-234"><a href="#cb68-234" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(slope_samples, <span class="at">probs =</span> <span class="dv">1</span> <span class="sc">-</span> alpha<span class="sc">/</span><span class="dv">2</span>)), <span class="dv">2</span>)</span>
<span id="cb68-235"><a href="#cb68-235" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-236"><a href="#cb68-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-237"><a href="#cb68-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-238"><a href="#cb68-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-239"><a href="#cb68-239" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Further task</span></span>
<span id="cb68-240"><a href="#cb68-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-241"><a href="#cb68-241" aria-hidden="true" tabindex="-1"></a>Experiment by changing the priors and the proposal distribution, then run the sampler again. Observe how these changes affect convergence, acceptance rate, and the shape and location of the posterior distributions.</span>
<span id="cb68-242"><a href="#cb68-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-243"><a href="#cb68-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-244"><a href="#cb68-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-245"><a href="#cb68-245" aria-hidden="true" tabindex="-1"></a><span class="fu">## Activity 2 — Linear regression in Stan</span></span>
<span id="cb68-246"><a href="#cb68-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-247"><a href="#cb68-247" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Goal: Fit a no-intercept Bayesian linear regression to the Hubble data in Stan, check convergence, summarize the posterior for β and σ, and then transform the posterior for β into a posterior for the age of the universe (in billions of years). Finally, visualize uncertainty both on the parameter and data scales.</span></span>
<span id="cb68-248"><a href="#cb68-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-249"><a href="#cb68-249" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Setup</span></span>
<span id="cb68-250"><a href="#cb68-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-251"><a href="#cb68-251" aria-hidden="true" tabindex="-1"></a>Load data</span>
<span id="cb68-252"><a href="#cb68-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-255"><a href="#cb68-255" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-256"><a href="#cb68-256" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/hubble.csv"</span>)</span>
<span id="cb68-257"><a href="#cb68-257" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(d)</span>
<span id="cb68-258"><a href="#cb68-258" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(d)</span>
<span id="cb68-259"><a href="#cb68-259" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-260"><a href="#cb68-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-261"><a href="#cb68-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-262"><a href="#cb68-262" aria-hidden="true" tabindex="-1"></a>Quick plot</span>
<span id="cb68-263"><a href="#cb68-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-266"><a href="#cb68-266" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-267"><a href="#cb68-267" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: 'center'</span></span>
<span id="cb68-268"><a href="#cb68-268" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap-location: margin</span></span>
<span id="cb68-269"><a href="#cb68-269" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 4</span></span>
<span id="cb68-270"><a href="#cb68-270" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4.5</span></span>
<span id="cb68-271"><a href="#cb68-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-272"><a href="#cb68-272" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(d<span class="sc">$</span>distance, d<span class="sc">$</span>velocity,</span>
<span id="cb68-273"><a href="#cb68-273" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Distance [Mpc]"</span>, <span class="at">ylab=</span><span class="st">"Velocity [km/s]"</span>,</span>
<span id="cb68-274"><a href="#cb68-274" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch=</span><span class="dv">19</span>)</span>
<span id="cb68-275"><a href="#cb68-275" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-276"><a href="#cb68-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-277"><a href="#cb68-277" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 1) Stan code</span></span>
<span id="cb68-278"><a href="#cb68-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-279"><a href="#cb68-279" aria-hidden="true" tabindex="-1"></a>Saved in the repository as <span class="in">`stan_code/hubble_model.stan`</span></span>
<span id="cb68-280"><a href="#cb68-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-281"><a href="#cb68-281" aria-hidden="true" tabindex="-1"></a><span class="in">```{.stan}</span></span>
<span id="cb68-282"><a href="#cb68-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-283"><a href="#cb68-283" aria-hidden="true" tabindex="-1"></a><span class="in">data {</span></span>
<span id="cb68-284"><a href="#cb68-284" aria-hidden="true" tabindex="-1"></a><span class="in">  int&lt;lower=1&gt; N;</span></span>
<span id="cb68-285"><a href="#cb68-285" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[N] distance;   // Mpc</span></span>
<span id="cb68-286"><a href="#cb68-286" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[N] velocity;   // km/s</span></span>
<span id="cb68-287"><a href="#cb68-287" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb68-288"><a href="#cb68-288" aria-hidden="true" tabindex="-1"></a><span class="in">parameters {</span></span>
<span id="cb68-289"><a href="#cb68-289" aria-hidden="true" tabindex="-1"></a><span class="in">  real&lt;lower=0&gt; beta;   // (km/s)/Mpc</span></span>
<span id="cb68-290"><a href="#cb68-290" aria-hidden="true" tabindex="-1"></a><span class="in">  real&lt;lower=0&gt; sigma;  // km/s</span></span>
<span id="cb68-291"><a href="#cb68-291" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb68-292"><a href="#cb68-292" aria-hidden="true" tabindex="-1"></a><span class="in">model {</span></span>
<span id="cb68-293"><a href="#cb68-293" aria-hidden="true" tabindex="-1"></a><span class="in">  // weakly-informative half-normal style via &lt;lower=0&gt;</span></span>
<span id="cb68-294"><a href="#cb68-294" aria-hidden="true" tabindex="-1"></a><span class="in">  beta  ~ normal(0, 200);</span></span>
<span id="cb68-295"><a href="#cb68-295" aria-hidden="true" tabindex="-1"></a><span class="in">  sigma ~ normal(0, 2000);</span></span>
<span id="cb68-296"><a href="#cb68-296" aria-hidden="true" tabindex="-1"></a><span class="in">  velocity ~ normal(beta * distance, sigma);</span></span>
<span id="cb68-297"><a href="#cb68-297" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb68-298"><a href="#cb68-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-299"><a href="#cb68-299" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-300"><a href="#cb68-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-301"><a href="#cb68-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-302"><a href="#cb68-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-303"><a href="#cb68-303" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 2) Preparing data for modelling in Stan</span></span>
<span id="cb68-304"><a href="#cb68-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-305"><a href="#cb68-305" aria-hidden="true" tabindex="-1"></a>We prepare data as list, and include also the number of observations <span class="in">`N`</span>, which is needed in Stan to declare the size of data vectors.</span>
<span id="cb68-306"><a href="#cb68-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-309"><a href="#cb68-309" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-310"><a href="#cb68-310" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb68-311"><a href="#cb68-311" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">nrow</span>(d),</span>
<span id="cb68-312"><a href="#cb68-312" aria-hidden="true" tabindex="-1"></a>  <span class="at">distance =</span> d<span class="sc">$</span>distance,  <span class="co"># Mpc</span></span>
<span id="cb68-313"><a href="#cb68-313" aria-hidden="true" tabindex="-1"></a>  <span class="at">velocity =</span> d<span class="sc">$</span>velocity   <span class="co"># km/s</span></span>
<span id="cb68-314"><a href="#cb68-314" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-315"><a href="#cb68-315" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(stan_data)</span>
<span id="cb68-316"><a href="#cb68-316" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-317"><a href="#cb68-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-318"><a href="#cb68-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-319"><a href="#cb68-319" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 3) Fit the model and check convergence</span></span>
<span id="cb68-320"><a href="#cb68-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-321"><a href="#cb68-321" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=FALSE}</span></span>
<span id="cb68-322"><a href="#cb68-322" aria-hidden="true" tabindex="-1"></a><span class="in">fit &lt;- readRDS("outputs/hubble_fit.RDS")</span></span>
<span id="cb68-323"><a href="#cb68-323" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-324"><a href="#cb68-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-325"><a href="#cb68-325" aria-hidden="true" tabindex="-1"></a>Load <span class="in">`rstan`</span> library and run sampling of posterior</span>
<span id="cb68-326"><a href="#cb68-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-327"><a href="#cb68-327" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb68-328"><a href="#cb68-328" aria-hidden="true" tabindex="-1"></a><span class="in">library(rstan)</span></span>
<span id="cb68-329"><a href="#cb68-329" aria-hidden="true" tabindex="-1"></a><span class="in">rstan_options(auto_write = TRUE)</span></span>
<span id="cb68-330"><a href="#cb68-330" aria-hidden="true" tabindex="-1"></a><span class="in">options(mc.cores = max(1, parallel::detectCores() - 1))</span></span>
<span id="cb68-331"><a href="#cb68-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-332"><a href="#cb68-332" aria-hidden="true" tabindex="-1"></a><span class="in">fit &lt;- stan(</span></span>
<span id="cb68-333"><a href="#cb68-333" aria-hidden="true" tabindex="-1"></a><span class="in">  file = "stan_code/hubble_model.stan",</span></span>
<span id="cb68-334"><a href="#cb68-334" aria-hidden="true" tabindex="-1"></a><span class="in">  data = stan_data,</span></span>
<span id="cb68-335"><a href="#cb68-335" aria-hidden="true" tabindex="-1"></a><span class="in">  iter = 2000,</span></span>
<span id="cb68-336"><a href="#cb68-336" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4)</span></span>
<span id="cb68-337"><a href="#cb68-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-338"><a href="#cb68-338" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-339"><a href="#cb68-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-340"><a href="#cb68-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-341"><a href="#cb68-341" aria-hidden="true" tabindex="-1"></a>Extract the posterior samples, and store them in a database format using the <span class="in">`tidybayes`</span> package</span>
<span id="cb68-342"><a href="#cb68-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-343"><a href="#cb68-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-346"><a href="#cb68-346" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-347"><a href="#cb68-347" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb68-348"><a href="#cb68-348" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb68-349"><a href="#cb68-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-350"><a href="#cb68-350" aria-hidden="true" tabindex="-1"></a>posterior_samples <span class="ot">&lt;-</span> fit <span class="sc">%&gt;%</span></span>
<span id="cb68-351"><a href="#cb68-351" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(beta) </span>
<span id="cb68-352"><a href="#cb68-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-353"><a href="#cb68-353" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(posterior_samples)</span>
<span id="cb68-354"><a href="#cb68-354" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-355"><a href="#cb68-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-356"><a href="#cb68-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-357"><a href="#cb68-357" aria-hidden="true" tabindex="-1"></a>Examine results &amp; assess convergence</span>
<span id="cb68-358"><a href="#cb68-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-361"><a href="#cb68-361" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-362"><a href="#cb68-362" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"beta"</span>,<span class="st">"sigma"</span>), <span class="at">probs =</span> <span class="fu">c</span>(.<span class="dv">025</span>,.<span class="dv">5</span>,.<span class="dv">975</span>))</span>
<span id="cb68-363"><a href="#cb68-363" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"beta"</span>,<span class="st">"sigma"</span>))</span>
<span id="cb68-364"><a href="#cb68-364" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-365"><a href="#cb68-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-366"><a href="#cb68-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-367"><a href="#cb68-367" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 3) Extract posterior draws and estimate the age of the universe</span></span>
<span id="cb68-368"><a href="#cb68-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-371"><a href="#cb68-371" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-372"><a href="#cb68-372" aria-hidden="true" tabindex="-1"></a>mpc_km <span class="ot">&lt;-</span> <span class="fl">3.09e19</span> <span class="co"># km per Megaparsec</span></span>
<span id="cb68-373"><a href="#cb68-373" aria-hidden="true" tabindex="-1"></a>sec_per_year <span class="ot">&lt;-</span> <span class="dv">60</span><span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="dv">24</span> <span class="sc">*</span> <span class="dv">365</span></span>
<span id="cb68-374"><a href="#cb68-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-375"><a href="#cb68-375" aria-hidden="true" tabindex="-1"></a><span class="co"># transform in Km</span></span>
<span id="cb68-376"><a href="#cb68-376" aria-hidden="true" tabindex="-1"></a>hubble.const <span class="ot">&lt;-</span> posterior_samples<span class="sc">$</span>beta<span class="sc">/</span> mpc_km </span>
<span id="cb68-377"><a href="#cb68-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-378"><a href="#cb68-378" aria-hidden="true" tabindex="-1"></a><span class="co"># invert to get age in seconds</span></span>
<span id="cb68-379"><a href="#cb68-379" aria-hidden="true" tabindex="-1"></a>age <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>hubble.const</span>
<span id="cb68-380"><a href="#cb68-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-381"><a href="#cb68-381" aria-hidden="true" tabindex="-1"></a><span class="co"># transform age in billion years</span></span>
<span id="cb68-382"><a href="#cb68-382" aria-hidden="true" tabindex="-1"></a>age <span class="ot">&lt;-</span> (age<span class="sc">/</span>sec_per_year) <span class="sc">/</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">9</span></span>
<span id="cb68-383"><a href="#cb68-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-384"><a href="#cb68-384" aria-hidden="true" tabindex="-1"></a><span class="co"># point estimate</span></span>
<span id="cb68-385"><a href="#cb68-385" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(age)</span>
<span id="cb68-386"><a href="#cb68-386" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-387"><a href="#cb68-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-388"><a href="#cb68-388" aria-hidden="true" tabindex="-1"></a>We can use a percentile method to determine a credibility interval</span>
<span id="cb68-389"><a href="#cb68-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-392"><a href="#cb68-392" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-393"><a href="#cb68-393" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% Bayesian credible interval</span></span>
<span id="cb68-394"><a href="#cb68-394" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb68-395"><a href="#cb68-395" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">c</span>(<span class="fu">quantile</span>(age, <span class="at">probs =</span> alpha<span class="sc">/</span><span class="dv">2</span>),</span>
<span id="cb68-396"><a href="#cb68-396" aria-hidden="true" tabindex="-1"></a>        <span class="fu">quantile</span>(age, <span class="at">probs =</span> <span class="dv">1</span><span class="sc">-</span>alpha<span class="sc">/</span><span class="dv">2</span>)),</span>
<span id="cb68-397"><a href="#cb68-397" aria-hidden="true" tabindex="-1"></a>      <span class="at">digits=</span><span class="dv">2</span>)</span>
<span id="cb68-398"><a href="#cb68-398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-399"><a href="#cb68-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-400"><a href="#cb68-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-401"><a href="#cb68-401" aria-hidden="true" tabindex="-1"></a>::: callout-tip</span>
<span id="cb68-402"><a href="#cb68-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-403"><a href="#cb68-403" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Highest posterior density interval</span></span>
<span id="cb68-404"><a href="#cb68-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-405"><a href="#cb68-405" aria-hidden="true" tabindex="-1"></a>The percentile method works well in most cases but can be misleading for asymmetric posteriors, where for example the mode (the most probable value) may fall outside the interval.</span>
<span id="cb68-406"><a href="#cb68-406" aria-hidden="true" tabindex="-1"></a>A highest posterior density (HPD, also referred to as HDI) interval is the shortest interval containing a specified proportion of the posterior mass. _Every point inside has higher probability density than any point outside._</span>
<span id="cb68-407"><a href="#cb68-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-408"><a href="#cb68-408" aria-hidden="true" tabindex="-1"></a>In our example, the posterior for β is roughly symmetric, so percentile and HPD intervals are nearly identical.</span>
<span id="cb68-409"><a href="#cb68-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-410"><a href="#cb68-410" aria-hidden="true" tabindex="-1"></a>Here is how we can compute this using the handy <span class="in">`tidybayes`</span> package</span>
<span id="cb68-411"><a href="#cb68-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-414"><a href="#cb68-414" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-415"><a href="#cb68-415" aria-hidden="true" tabindex="-1"></a>fit <span class="sc">%&gt;%</span></span>
<span id="cb68-416"><a href="#cb68-416" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(beta) <span class="sc">%&gt;%</span> </span>
<span id="cb68-417"><a href="#cb68-417" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean_hdi</span>(beta, <span class="at">.width =</span> <span class="fl">0.95</span>)</span>
<span id="cb68-418"><a href="#cb68-418" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-419"><a href="#cb68-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-420"><a href="#cb68-420" aria-hidden="true" tabindex="-1"></a>Or alternatively, computing the interval for more than one parameter at the same time:</span>
<span id="cb68-421"><a href="#cb68-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-424"><a href="#cb68-424" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-425"><a href="#cb68-425" aria-hidden="true" tabindex="-1"></a>fit <span class="sc">%&gt;%</span></span>
<span id="cb68-426"><a href="#cb68-426" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather_draws</span>(beta, sigma) <span class="sc">%&gt;%</span>  </span>
<span id="cb68-427"><a href="#cb68-427" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(.variable) <span class="sc">%&gt;%</span></span>
<span id="cb68-428"><a href="#cb68-428" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean_hdi</span>(.value, <span class="at">.width =</span> <span class="fl">0.95</span>)</span>
<span id="cb68-429"><a href="#cb68-429" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-430"><a href="#cb68-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-431"><a href="#cb68-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-432"><a href="#cb68-432" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-433"><a href="#cb68-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-434"><a href="#cb68-434" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 4) Visualisation of uncertainty</span></span>
<span id="cb68-435"><a href="#cb68-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-436"><a href="#cb68-436" aria-hidden="true" tabindex="-1"></a>Visualise posterior over the age of the universe as simple histogram</span>
<span id="cb68-437"><a href="#cb68-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-440"><a href="#cb68-440" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-441"><a href="#cb68-441" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: 'center'</span></span>
<span id="cb68-442"><a href="#cb68-442" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap-location: margin</span></span>
<span id="cb68-443"><a href="#cb68-443" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 6</span></span>
<span id="cb68-444"><a href="#cb68-444" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb68-445"><a href="#cb68-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-446"><a href="#cb68-446" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(age, <span class="at">breaks =</span><span class="dv">30</span>, <span class="at">xlab=</span><span class="st">"time (billions of years)"</span>)</span>
<span id="cb68-447"><a href="#cb68-447" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-448"><a href="#cb68-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-449"><a href="#cb68-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-450"><a href="#cb68-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-451"><a href="#cb68-451" aria-hidden="true" tabindex="-1"></a>We can make this a bit nicer e.g. by adding smooth density curve and credible interval</span>
<span id="cb68-452"><a href="#cb68-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-455"><a href="#cb68-455" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-456"><a href="#cb68-456" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: 'center'</span></span>
<span id="cb68-457"><a href="#cb68-457" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap-location: margin</span></span>
<span id="cb68-458"><a href="#cb68-458" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 6</span></span>
<span id="cb68-459"><a href="#cb68-459" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb68-460"><a href="#cb68-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-461"><a href="#cb68-461" aria-hidden="true" tabindex="-1"></a><span class="co"># Get HDI interval</span></span>
<span id="cb68-462"><a href="#cb68-462" aria-hidden="true" tabindex="-1"></a>hdi <span class="ot">&lt;-</span> <span class="fu">mean_hdi</span>(age, <span class="at">.width =</span> <span class="fl">0.95</span>)</span>
<span id="cb68-463"><a href="#cb68-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-464"><a href="#cb68-464" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute density</span></span>
<span id="cb68-465"><a href="#cb68-465" aria-hidden="true" tabindex="-1"></a>dens <span class="ot">&lt;-</span> <span class="fu">density</span>(age, <span class="at">adjust=</span><span class="dv">2</span>)</span>
<span id="cb68-466"><a href="#cb68-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-467"><a href="#cb68-467" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb68-468"><a href="#cb68-468" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dens, <span class="at">main =</span> <span class="st">""</span>, <span class="at">xlab =</span> <span class="st">"time (billions of years)"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb68-469"><a href="#cb68-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-470"><a href="#cb68-470" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill inside HDI</span></span>
<span id="cb68-471"><a href="#cb68-471" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(dens<span class="sc">$</span>x[dens<span class="sc">$</span>x <span class="sc">&gt;=</span> hdi<span class="sc">$</span>ymin <span class="sc">&amp;</span> dens<span class="sc">$</span>x <span class="sc">&lt;=</span> hdi<span class="sc">$</span>ymax], hdi<span class="sc">$</span>ymax, hdi<span class="sc">$</span>ymin),</span>
<span id="cb68-472"><a href="#cb68-472" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(dens<span class="sc">$</span>y[dens<span class="sc">$</span>x <span class="sc">&gt;=</span> hdi<span class="sc">$</span>ymin <span class="sc">&amp;</span> dens<span class="sc">$</span>x <span class="sc">&lt;=</span> hdi<span class="sc">$</span>ymax], <span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb68-473"><a href="#cb68-473" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">border =</span> <span class="cn">NA</span>)</span>
<span id="cb68-474"><a href="#cb68-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-475"><a href="#cb68-475" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill outside HDI</span></span>
<span id="cb68-476"><a href="#cb68-476" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(dens<span class="sc">$</span>x[dens<span class="sc">$</span>x <span class="sc">&lt;</span> hdi<span class="sc">$</span>ymin], hdi<span class="sc">$</span>ymin, dens<span class="sc">$</span>x[<span class="dv">1</span>]),</span>
<span id="cb68-477"><a href="#cb68-477" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(dens<span class="sc">$</span>y[dens<span class="sc">$</span>x <span class="sc">&lt;</span> hdi<span class="sc">$</span>ymin], <span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb68-478"><a href="#cb68-478" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="st">"gray90"</span>, <span class="at">border =</span> <span class="cn">NA</span>)</span>
<span id="cb68-479"><a href="#cb68-479" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(hdi<span class="sc">$</span>ymax, dens<span class="sc">$</span>x[dens<span class="sc">$</span>x <span class="sc">&gt;</span> hdi<span class="sc">$</span>ymax], <span class="fu">rev</span>(dens<span class="sc">$</span>x[dens<span class="sc">$</span>x <span class="sc">&gt;</span> hdi<span class="sc">$</span>ymax])[<span class="dv">1</span>]),</span>
<span id="cb68-480"><a href="#cb68-480" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(<span class="dv">0</span>, dens<span class="sc">$</span>y[dens<span class="sc">$</span>x <span class="sc">&gt;</span> hdi<span class="sc">$</span>ymax], <span class="dv">0</span>),</span>
<span id="cb68-481"><a href="#cb68-481" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="st">"gray90"</span>, <span class="at">border =</span> <span class="cn">NA</span>)</span>
<span id="cb68-482"><a href="#cb68-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-483"><a href="#cb68-483" aria-hidden="true" tabindex="-1"></a><span class="co"># Redraw density line on top</span></span>
<span id="cb68-484"><a href="#cb68-484" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(dens, <span class="at">lwd =</span> <span class="dv">3</span>)</span>
<span id="cb68-485"><a href="#cb68-485" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-486"><a href="#cb68-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-487"><a href="#cb68-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-488"><a href="#cb68-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-489"><a href="#cb68-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-490"><a href="#cb68-490" aria-hidden="true" tabindex="-1"></a>We can also visualise posterior samples as regression lines, to give a visual summary of the precision of model predictions</span>
<span id="cb68-491"><a href="#cb68-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-494"><a href="#cb68-494" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-495"><a href="#cb68-495" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: 'center'</span></span>
<span id="cb68-496"><a href="#cb68-496" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap-location: margin</span></span>
<span id="cb68-497"><a href="#cb68-497" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 6</span></span>
<span id="cb68-498"><a href="#cb68-498" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5.5</span></span>
<span id="cb68-499"><a href="#cb68-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-500"><a href="#cb68-500" aria-hidden="true" tabindex="-1"></a><span class="co"># basic plot</span></span>
<span id="cb68-501"><a href="#cb68-501" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(d<span class="sc">$</span>distance, d<span class="sc">$</span>velocity, <span class="at">xlab =</span> <span class="st">"Distance (Mpc)"</span>, <span class="at">ylab =</span> <span class="st">"Velocity (km/s)"</span>, <span class="at">pch =</span> <span class="dv">19</span>)</span>
<span id="cb68-502"><a href="#cb68-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-503"><a href="#cb68-503" aria-hidden="true" tabindex="-1"></a><span class="co"># draw a subset of posterior lines</span></span>
<span id="cb68-504"><a href="#cb68-504" aria-hidden="true" tabindex="-1"></a>idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">seq_along</span>(posterior_samples<span class="sc">$</span>beta), <span class="dv">500</span>)</span>
<span id="cb68-505"><a href="#cb68-505" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> idx){</span>
<span id="cb68-506"><a href="#cb68-506" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> posterior_samples<span class="sc">$</span>beta[i], <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="fl">0.08</span>))</span>
<span id="cb68-507"><a href="#cb68-507" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-508"><a href="#cb68-508" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="fu">median</span>(posterior_samples<span class="sc">$</span>beta), <span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb68-509"><a href="#cb68-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-510"><a href="#cb68-510" aria-hidden="true" tabindex="-1"></a><span class="co"># (redraw the points to prevent them being hidden by the lines)</span></span>
<span id="cb68-511"><a href="#cb68-511" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(d<span class="sc">$</span>distance, d<span class="sc">$</span>velocity, <span class="at">pch=</span><span class="dv">19</span>)</span>
<span id="cb68-512"><a href="#cb68-512" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-513"><a href="#cb68-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-514"><a href="#cb68-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-515"><a href="#cb68-515" aria-hidden="true" tabindex="-1"></a>::: callout-tip</span>
<span id="cb68-516"><a href="#cb68-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-517"><a href="#cb68-517" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Using the "Generated quantities" block</span></span>
<span id="cb68-518"><a href="#cb68-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-519"><a href="#cb68-519" aria-hidden="true" tabindex="-1"></a>Stan models have also other types of block. One of them is the generated quantities block, which we can use to compute quantities of interest that depends on posterior parameters. in this block we can include also functions that simulates data, so it is useful for things such as _posterior predictive checks_.</span>
<span id="cb68-520"><a href="#cb68-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-521"><a href="#cb68-521" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb68-522"><a href="#cb68-522" aria-hidden="true" tabindex="-1"></a><span class="in">stan_code &lt;- "</span></span>
<span id="cb68-523"><a href="#cb68-523" aria-hidden="true" tabindex="-1"></a><span class="in">data {</span></span>
<span id="cb68-524"><a href="#cb68-524" aria-hidden="true" tabindex="-1"></a><span class="in">  int&lt;lower=1&gt; N;</span></span>
<span id="cb68-525"><a href="#cb68-525" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[N] distance; </span></span>
<span id="cb68-526"><a href="#cb68-526" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[N] velocity; </span></span>
<span id="cb68-527"><a href="#cb68-527" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb68-528"><a href="#cb68-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-529"><a href="#cb68-529" aria-hidden="true" tabindex="-1"></a><span class="in">parameters {</span></span>
<span id="cb68-530"><a href="#cb68-530" aria-hidden="true" tabindex="-1"></a><span class="in">  real&lt;lower=0&gt; beta; </span></span>
<span id="cb68-531"><a href="#cb68-531" aria-hidden="true" tabindex="-1"></a><span class="in">  real&lt;lower=0&gt; sigma;</span></span>
<span id="cb68-532"><a href="#cb68-532" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb68-533"><a href="#cb68-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-534"><a href="#cb68-534" aria-hidden="true" tabindex="-1"></a><span class="in">model {</span></span>
<span id="cb68-535"><a href="#cb68-535" aria-hidden="true" tabindex="-1"></a><span class="in">  beta ~ normal(0, 200);</span></span>
<span id="cb68-536"><a href="#cb68-536" aria-hidden="true" tabindex="-1"></a><span class="in">  sigma ~ normal(0, 2000);</span></span>
<span id="cb68-537"><a href="#cb68-537" aria-hidden="true" tabindex="-1"></a><span class="in">  velocity ~ normal(beta * distance, sigma);</span></span>
<span id="cb68-538"><a href="#cb68-538" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb68-539"><a href="#cb68-539" aria-hidden="true" tabindex="-1"></a><span class="in">generated quantities {</span></span>
<span id="cb68-540"><a href="#cb68-540" aria-hidden="true" tabindex="-1"></a><span class="in">  real mpc_km; </span></span>
<span id="cb68-541"><a href="#cb68-541" aria-hidden="true" tabindex="-1"></a><span class="in">  real sec_per_year;</span></span>
<span id="cb68-542"><a href="#cb68-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-543"><a href="#cb68-543" aria-hidden="true" tabindex="-1"></a><span class="in">  mpc_km = 3.09 * 10^19;</span></span>
<span id="cb68-544"><a href="#cb68-544" aria-hidden="true" tabindex="-1"></a><span class="in">  sec_per_year = 60^2 * 24 * 365;</span></span>
<span id="cb68-545"><a href="#cb68-545" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb68-546"><a href="#cb68-546" aria-hidden="true" tabindex="-1"></a><span class="in">  real age_universe = ((mpc_km / beta) / sec_per_year) / 1e9;</span></span>
<span id="cb68-547"><a href="#cb68-547" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb68-548"><a href="#cb68-548" aria-hidden="true" tabindex="-1"></a><span class="in">"</span></span>
<span id="cb68-549"><a href="#cb68-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-550"><a href="#cb68-550" aria-hidden="true" tabindex="-1"></a><span class="in">fit &lt;- stan(</span></span>
<span id="cb68-551"><a href="#cb68-551" aria-hidden="true" tabindex="-1"></a><span class="in">  model_code = stan_code,</span></span>
<span id="cb68-552"><a href="#cb68-552" aria-hidden="true" tabindex="-1"></a><span class="in">  data = stan_data,</span></span>
<span id="cb68-553"><a href="#cb68-553" aria-hidden="true" tabindex="-1"></a><span class="in">  iter = 2000,</span></span>
<span id="cb68-554"><a href="#cb68-554" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4)</span></span>
<span id="cb68-555"><a href="#cb68-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-556"><a href="#cb68-556" aria-hidden="true" tabindex="-1"></a><span class="in">print(fit, pars = c("beta","sigma", "age_universe"), probs = c(.025,.5,.975))</span></span>
<span id="cb68-557"><a href="#cb68-557" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-558"><a href="#cb68-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-559"><a href="#cb68-559" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,echo=FALSE}</span></span>
<span id="cb68-560"><a href="#cb68-560" aria-hidden="true" tabindex="-1"></a><span class="in">fit &lt;- readRDS("outputs/hubble_fit_2.RDS")</span></span>
<span id="cb68-561"><a href="#cb68-561" aria-hidden="true" tabindex="-1"></a><span class="in">print(fit, pars = c("beta","sigma", "age_universe"), probs = c(.025,.5,.975))</span></span>
<span id="cb68-562"><a href="#cb68-562" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-563"><a href="#cb68-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-564"><a href="#cb68-564" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-565"><a href="#cb68-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-566"><a href="#cb68-566" aria-hidden="true" tabindex="-1"></a><span class="fu">## Activity 3 — Overdispersed Poisson GLMM</span></span>
<span id="cb68-567"><a href="#cb68-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-568"><a href="#cb68-568" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Goal: Model the rate of police stops across ethnic groups and precincts, adjusting for exposure (arrests) and allowing for *overdispersion* and *hierarchical structure*.</span></span>
<span id="cb68-569"><a href="#cb68-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-570"><a href="#cb68-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-571"><a href="#cb68-571" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Context:**  Study of the NYPD *stop-and-frisk* policy, investigating possible ethnic bias in police stops.</span>
<span id="cb68-572"><a href="#cb68-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-573"><a href="#cb68-573" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Source:**  Records of ≈175,000 stops over 15 months (1998–1999), obtained by the New York State Attorney General’s Office.</span>
<span id="cb68-574"><a href="#cb68-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-575"><a href="#cb68-575" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Variables:**  </span>
<span id="cb68-576"><a href="#cb68-576" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`stops`</span> — Number of police stops recorded in 1998–1999 for the cell.</span>
<span id="cb68-577"><a href="#cb68-577" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`pop`</span> — Estimated population size of the ethnic group within the precinct (exposure candidate).</span>
<span id="cb68-578"><a href="#cb68-578" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`past.arrests`</span> — Number of 1997 arrests (DCJS) for the same group/crime category (proxy for crime exposure).</span>
<span id="cb68-579"><a href="#cb68-579" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`precinct`</span> — Precinct ID (integers **1–75**).</span>
<span id="cb68-580"><a href="#cb68-580" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`eth`</span> — Ethnicity code: **1 = Black**, **2 = Hispanic**, **3 = White**.</span>
<span id="cb68-581"><a href="#cb68-581" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`crime`</span> — Crime category: **1 = violent**, **2 = weapons**, **3 = property**, **4 = drug**.</span>
<span id="cb68-582"><a href="#cb68-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-583"><a href="#cb68-583" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Setup</span></span>
<span id="cb68-584"><a href="#cb68-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-585"><a href="#cb68-585" aria-hidden="true" tabindex="-1"></a>Load data into R</span>
<span id="cb68-586"><a href="#cb68-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-589"><a href="#cb68-589" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-590"><a href="#cb68-590" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(<span class="st">"data/police_stops.txt"</span>)</span>
<span id="cb68-591"><a href="#cb68-591" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(d)</span>
<span id="cb68-592"><a href="#cb68-592" aria-hidden="true" tabindex="-1"></a> <span class="fu">print</span>(d, <span class="at">n=</span><span class="dv">14</span>)</span>
<span id="cb68-593"><a href="#cb68-593" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-594"><a href="#cb68-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-595"><a href="#cb68-595" aria-hidden="true" tabindex="-1"></a>We first add crime and stop counts over crime type (i.e. we are pooling together all crime types)</span>
<span id="cb68-596"><a href="#cb68-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-599"><a href="#cb68-599" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-600"><a href="#cb68-600" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb68-601"><a href="#cb68-601" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(precinct, eth) <span class="sc">%&gt;%</span></span>
<span id="cb68-602"><a href="#cb68-602" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">stops =</span> <span class="fu">sum</span>(stops),</span>
<span id="cb68-603"><a href="#cb68-603" aria-hidden="true" tabindex="-1"></a>         <span class="at">past.arrests =</span> <span class="fu">sum</span>(past.arrests),</span>
<span id="cb68-604"><a href="#cb68-604" aria-hidden="true" tabindex="-1"></a>         <span class="at">pop =</span> <span class="fu">unique</span>(pop))</span>
<span id="cb68-605"><a href="#cb68-605" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-606"><a href="#cb68-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-607"><a href="#cb68-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-608"><a href="#cb68-608" aria-hidden="true" tabindex="-1"></a>Compute summary statistics (averaging across the whole city). </span>
<span id="cb68-609"><a href="#cb68-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-612"><a href="#cb68-612" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-613"><a href="#cb68-613" aria-hidden="true" tabindex="-1"></a>d_summaries <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb68-614"><a href="#cb68-614" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">eth =</span> <span class="fu">case_when</span>(</span>
<span id="cb68-615"><a href="#cb68-615" aria-hidden="true" tabindex="-1"></a>    eth <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"black"</span>,</span>
<span id="cb68-616"><a href="#cb68-616" aria-hidden="true" tabindex="-1"></a>    eth <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"hispanic"</span>,</span>
<span id="cb68-617"><a href="#cb68-617" aria-hidden="true" tabindex="-1"></a>    eth <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="st">"white"</span></span>
<span id="cb68-618"><a href="#cb68-618" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb68-619"><a href="#cb68-619" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(eth) <span class="sc">%&gt;%</span></span>
<span id="cb68-620"><a href="#cb68-620" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb68-621"><a href="#cb68-621" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop           =</span> <span class="fu">sum</span>(pop),</span>
<span id="cb68-622"><a href="#cb68-622" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_stops   =</span> <span class="fu">sum</span>(stops),</span>
<span id="cb68-623"><a href="#cb68-623" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_arrests =</span> <span class="fu">sum</span>(past.arrests),</span>
<span id="cb68-624"><a href="#cb68-624" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb68-625"><a href="#cb68-625" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb68-626"><a href="#cb68-626" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb68-627"><a href="#cb68-627" aria-hidden="true" tabindex="-1"></a>    <span class="at">prop_of_all_stops =</span> total_stops <span class="sc">/</span> <span class="fu">sum</span>(total_stops),</span>
<span id="cb68-628"><a href="#cb68-628" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_fraction      =</span> pop <span class="sc">/</span> <span class="fu">sum</span>(pop)</span>
<span id="cb68-629"><a href="#cb68-629" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb68-630"><a href="#cb68-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-631"><a href="#cb68-631" aria-hidden="true" tabindex="-1"></a>d_summaries</span>
<span id="cb68-632"><a href="#cb68-632" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-633"><a href="#cb68-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-634"><a href="#cb68-634" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 1) Prepare data for Stan</span></span>
<span id="cb68-635"><a href="#cb68-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-636"><a href="#cb68-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-637"><a href="#cb68-637" aria-hidden="true" tabindex="-1"></a>Important: If <span class="in">`past.arrests == 0`</span> for some rows but stops are nonzero, we need to avoid a zero Poisson mean. In this case however no adjustment is needed (otherwise we could have added a small constant, e.g. 0.5, to zeroes in <span class="in">`past.arrests`</span>)</span>
<span id="cb68-638"><a href="#cb68-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-641"><a href="#cb68-641" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-642"><a href="#cb68-642" aria-hidden="true" tabindex="-1"></a><span class="fu">any</span>(d<span class="sc">$</span>past.arrests <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb68-643"><a href="#cb68-643" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-644"><a href="#cb68-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-645"><a href="#cb68-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-646"><a href="#cb68-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-649"><a href="#cb68-649" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-650"><a href="#cb68-650" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb68-651"><a href="#cb68-651" aria-hidden="true" tabindex="-1"></a>  <span class="at">N         =</span> <span class="fu">nrow</span>(d),</span>
<span id="cb68-652"><a href="#cb68-652" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_eth     =</span> <span class="fu">length</span>(<span class="fu">unique</span>(d<span class="sc">$</span>eth)),</span>
<span id="cb68-653"><a href="#cb68-653" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_prec    =</span> <span class="fu">length</span>(<span class="fu">unique</span>(d<span class="sc">$</span>precinct)),</span>
<span id="cb68-654"><a href="#cb68-654" aria-hidden="true" tabindex="-1"></a>  <span class="at">y         =</span> d<span class="sc">$</span>stops,</span>
<span id="cb68-655"><a href="#cb68-655" aria-hidden="true" tabindex="-1"></a>  <span class="at">eth       =</span> d<span class="sc">$</span>eth,</span>
<span id="cb68-656"><a href="#cb68-656" aria-hidden="true" tabindex="-1"></a>  <span class="at">past_arrests  =</span> d<span class="sc">$</span>past.arrests,</span>
<span id="cb68-657"><a href="#cb68-657" aria-hidden="true" tabindex="-1"></a>  <span class="at">precinct  =</span> d<span class="sc">$</span>precinct</span>
<span id="cb68-658"><a href="#cb68-658" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-659"><a href="#cb68-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-660"><a href="#cb68-660" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(stan_data)</span>
<span id="cb68-661"><a href="#cb68-661" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-662"><a href="#cb68-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-663"><a href="#cb68-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-664"><a href="#cb68-664" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 2) Stan code</span></span>
<span id="cb68-665"><a href="#cb68-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-666"><a href="#cb68-666" aria-hidden="true" tabindex="-1"></a>The code of the model is in the file <span class="in">`overdispersed_poisson.stan`</span></span>
<span id="cb68-667"><a href="#cb68-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-668"><a href="#cb68-668" aria-hidden="true" tabindex="-1"></a><span class="in">```{.stan}</span></span>
<span id="cb68-669"><a href="#cb68-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-670"><a href="#cb68-670" aria-hidden="true" tabindex="-1"></a><span class="in">data {</span></span>
<span id="cb68-671"><a href="#cb68-671" aria-hidden="true" tabindex="-1"></a><span class="in">  int&lt;lower=1&gt; N;          // total # of (eth, precinct) data points</span></span>
<span id="cb68-672"><a href="#cb68-672" aria-hidden="true" tabindex="-1"></a><span class="in">  int&lt;lower=1&gt; n_eth;      // number of ethnicity categories, e.g. 3</span></span>
<span id="cb68-673"><a href="#cb68-673" aria-hidden="true" tabindex="-1"></a><span class="in">  int&lt;lower=1&gt; n_prec;     // number of precincts</span></span>
<span id="cb68-674"><a href="#cb68-674" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb68-675"><a href="#cb68-675" aria-hidden="true" tabindex="-1"></a><span class="in">  int&lt;lower=0&gt; y[N];       // outcome counts y_{ep}</span></span>
<span id="cb68-676"><a href="#cb68-676" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[N] past_arrests;  // baseline/reference rate</span></span>
<span id="cb68-677"><a href="#cb68-677" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb68-678"><a href="#cb68-678" aria-hidden="true" tabindex="-1"></a><span class="in">  int&lt;lower=1, upper=n_eth&gt; eth[N];      // ethnicity ID for each row</span></span>
<span id="cb68-679"><a href="#cb68-679" aria-hidden="true" tabindex="-1"></a><span class="in">  int&lt;lower=1, upper=n_prec&gt; precinct[N]; // precinct ID for each row</span></span>
<span id="cb68-680"><a href="#cb68-680" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb68-681"><a href="#cb68-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-682"><a href="#cb68-682" aria-hidden="true" tabindex="-1"></a><span class="in">parameters {</span></span>
<span id="cb68-683"><a href="#cb68-683" aria-hidden="true" tabindex="-1"></a><span class="in">  // Ethnicity effects (fixed)</span></span>
<span id="cb68-684"><a href="#cb68-684" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[n_eth] alpha; </span></span>
<span id="cb68-685"><a href="#cb68-685" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb68-686"><a href="#cb68-686" aria-hidden="true" tabindex="-1"></a><span class="in">  // Random intercepts for precinct</span></span>
<span id="cb68-687"><a href="#cb68-687" aria-hidden="true" tabindex="-1"></a><span class="in">  real&lt;lower=0&gt; sigma_beta; </span></span>
<span id="cb68-688"><a href="#cb68-688" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[n_prec] beta_raw;   // non-centered param for precinct</span></span>
<span id="cb68-689"><a href="#cb68-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-690"><a href="#cb68-690" aria-hidden="true" tabindex="-1"></a><span class="in">  // Overdispersion</span></span>
<span id="cb68-691"><a href="#cb68-691" aria-hidden="true" tabindex="-1"></a><span class="in">  real&lt;lower=0&gt; sigma_eps;</span></span>
<span id="cb68-692"><a href="#cb68-692" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[N] eps_raw;         // non-centered param for each (e,p) observation</span></span>
<span id="cb68-693"><a href="#cb68-693" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb68-694"><a href="#cb68-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-695"><a href="#cb68-695" aria-hidden="true" tabindex="-1"></a><span class="in">transformed parameters {</span></span>
<span id="cb68-696"><a href="#cb68-696" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[n_prec] beta; </span></span>
<span id="cb68-697"><a href="#cb68-697" aria-hidden="true" tabindex="-1"></a><span class="in">  beta = sigma_beta * beta_raw;</span></span>
<span id="cb68-698"><a href="#cb68-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-699"><a href="#cb68-699" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[N] eps;</span></span>
<span id="cb68-700"><a href="#cb68-700" aria-hidden="true" tabindex="-1"></a><span class="in">  eps = sigma_eps * eps_raw;</span></span>
<span id="cb68-701"><a href="#cb68-701" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb68-702"><a href="#cb68-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-703"><a href="#cb68-703" aria-hidden="true" tabindex="-1"></a><span class="in">model {</span></span>
<span id="cb68-704"><a href="#cb68-704" aria-hidden="true" tabindex="-1"></a><span class="in">  // Priors</span></span>
<span id="cb68-705"><a href="#cb68-705" aria-hidden="true" tabindex="-1"></a><span class="in">  alpha ~ normal(0, 5);           </span></span>
<span id="cb68-706"><a href="#cb68-706" aria-hidden="true" tabindex="-1"></a><span class="in">  sigma_beta ~ exponential(1);    </span></span>
<span id="cb68-707"><a href="#cb68-707" aria-hidden="true" tabindex="-1"></a><span class="in">  beta_raw ~ normal(0, 1);</span></span>
<span id="cb68-708"><a href="#cb68-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-709"><a href="#cb68-709" aria-hidden="true" tabindex="-1"></a><span class="in">  sigma_eps ~ exponential(1);     </span></span>
<span id="cb68-710"><a href="#cb68-710" aria-hidden="true" tabindex="-1"></a><span class="in">  eps_raw ~ normal(0, 1);</span></span>
<span id="cb68-711"><a href="#cb68-711" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb68-712"><a href="#cb68-712" aria-hidden="true" tabindex="-1"></a><span class="in">  // Likelihood</span></span>
<span id="cb68-713"><a href="#cb68-713" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i in 1:N) {</span></span>
<span id="cb68-714"><a href="#cb68-714" aria-hidden="true" tabindex="-1"></a><span class="in">    y[i] ~ poisson(past_arrests[i] * (15.0 / 12.0) * exp(alpha[eth[i]] + beta[precinct[i]] + eps[i]));</span></span>
<span id="cb68-715"><a href="#cb68-715" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb68-716"><a href="#cb68-716" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb68-717"><a href="#cb68-717" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-718"><a href="#cb68-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-719"><a href="#cb68-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-720"><a href="#cb68-720" aria-hidden="true" tabindex="-1"></a>Note that we use a *non-centred* parametrisation for the random intercepts:</span>
<span id="cb68-721"><a href="#cb68-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-722"><a href="#cb68-722" aria-hidden="true" tabindex="-1"></a>$$\beta_p = \sigma_\beta \;\beta_{\text{raw},p}, \qquad \beta_{\text{raw},p} \sim N(0,1),$$</span>
<span id="cb68-723"><a href="#cb68-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-724"><a href="#cb68-724" aria-hidden="true" tabindex="-1"></a>instead of sampling $\beta_p$ directly from $N(0,\sigma_\beta^2)$. This often improves sampling efficiency in hierarchical models. The same logic applies to <span class="sc">\(</span>\epsilon_{ep}<span class="sc">\)</span>.</span>
<span id="cb68-725"><a href="#cb68-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-726"><a href="#cb68-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-727"><a href="#cb68-727" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 3) Compile and run</span></span>
<span id="cb68-728"><a href="#cb68-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-729"><a href="#cb68-729" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb68-730"><a href="#cb68-730" aria-hidden="true" tabindex="-1"></a><span class="in">fit &lt;- stan(</span></span>
<span id="cb68-731"><a href="#cb68-731" aria-hidden="true" tabindex="-1"></a><span class="in">  file = "stan_code/overdispersed_poisson.stan",</span></span>
<span id="cb68-732"><a href="#cb68-732" aria-hidden="true" tabindex="-1"></a><span class="in">  data = stan_data,</span></span>
<span id="cb68-733"><a href="#cb68-733" aria-hidden="true" tabindex="-1"></a><span class="in">  iter = 2000,</span></span>
<span id="cb68-734"><a href="#cb68-734" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4,</span></span>
<span id="cb68-735"><a href="#cb68-735" aria-hidden="true" tabindex="-1"></a><span class="in">  cores = 4)</span></span>
<span id="cb68-736"><a href="#cb68-736" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-737"><a href="#cb68-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-738"><a href="#cb68-738" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=FALSE}</span></span>
<span id="cb68-739"><a href="#cb68-739" aria-hidden="true" tabindex="-1"></a><span class="in">fit &lt;- readRDS("outputs/police_stops.RDS")</span></span>
<span id="cb68-740"><a href="#cb68-740" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-741"><a href="#cb68-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-742"><a href="#cb68-742" aria-hidden="true" tabindex="-1"></a>We can use the print method for a quick look at the results</span>
<span id="cb68-743"><a href="#cb68-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-746"><a href="#cb68-746" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-747"><a href="#cb68-747" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"sigma_beta"</span>, <span class="st">"sigma_eps"</span>))</span>
<span id="cb68-748"><a href="#cb68-748" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-749"><a href="#cb68-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-750"><a href="#cb68-750" aria-hidden="true" tabindex="-1"></a>Here, <span class="in">`alpha`</span> are the ethnic-group log-effects, <span class="in">`sigma_beta`</span> is the precinct-level standard deviation, and <span class="in">`sigma_eps`</span> is the observation-level overdispersion parameter.</span>
<span id="cb68-751"><a href="#cb68-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-752"><a href="#cb68-752" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 4) Diagnostic checks</span></span>
<span id="cb68-753"><a href="#cb68-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-756"><a href="#cb68-756" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-757"><a href="#cb68-757" aria-hidden="true" tabindex="-1"></a><span class="co"># Traceplots</span></span>
<span id="cb68-758"><a href="#cb68-758" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"sigma_beta"</span>, <span class="st">"sigma_eps"</span>))</span>
<span id="cb68-759"><a href="#cb68-759" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-760"><a href="#cb68-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-763"><a href="#cb68-763" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-764"><a href="#cb68-764" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: 'center'</span></span>
<span id="cb68-765"><a href="#cb68-765" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap-location: margin</span></span>
<span id="cb68-766"><a href="#cb68-766" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 5</span></span>
<span id="cb68-767"><a href="#cb68-767" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb68-768"><a href="#cb68-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-769"><a href="#cb68-769" aria-hidden="true" tabindex="-1"></a><span class="co"># Pairs plot for some key parameters</span></span>
<span id="cb68-770"><a href="#cb68-770" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"alpha[1]"</span>, <span class="st">"alpha[2]"</span>, <span class="st">"alpha[3]"</span>, <span class="st">"sigma_beta"</span>, <span class="st">"sigma_eps"</span>))</span>
<span id="cb68-771"><a href="#cb68-771" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-772"><a href="#cb68-772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-773"><a href="#cb68-773" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 5) Inference</span></span>
<span id="cb68-774"><a href="#cb68-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-775"><a href="#cb68-775" aria-hidden="true" tabindex="-1"></a>We use <span class="in">`tidybayes`</span> to extract samples and summarize. Suppose we want to look at the exponentiated ethnic effects (relative stops vs. arrests).</span>
<span id="cb68-776"><a href="#cb68-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-779"><a href="#cb68-779" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-780"><a href="#cb68-780" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb68-781"><a href="#cb68-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-782"><a href="#cb68-782" aria-hidden="true" tabindex="-1"></a>posterior <span class="ot">&lt;-</span> fit <span class="sc">%&gt;%</span> </span>
<span id="cb68-783"><a href="#cb68-783" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(alpha[e]) <span class="sc">%&gt;%</span></span>
<span id="cb68-784"><a href="#cb68-784" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rate =</span> <span class="fu">exp</span>(alpha))  <span class="co"># exponentiate to interpret as a multiplicative factor</span></span>
<span id="cb68-785"><a href="#cb68-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-786"><a href="#cb68-786" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the rate by ethnicity</span></span>
<span id="cb68-787"><a href="#cb68-787" aria-hidden="true" tabindex="-1"></a>posterior <span class="sc">%&gt;%</span></span>
<span id="cb68-788"><a href="#cb68-788" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(e) <span class="sc">%&gt;%</span></span>
<span id="cb68-789"><a href="#cb68-789" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean_hdi</span>(rate, <span class="at">.width =</span> <span class="fl">0.95</span>)</span>
<span id="cb68-790"><a href="#cb68-790" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-791"><a href="#cb68-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-792"><a href="#cb68-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-793"><a href="#cb68-793" aria-hidden="true" tabindex="-1"></a>If <span class="in">`e=1`</span> = black, <span class="in">`e=2`</span> = hispanic, <span class="in">`e=3`</span> = white, these give the average ratio of stops to arrests for each ethnicity, accounting for precinct and overdispersion.</span>
<span id="cb68-794"><a href="#cb68-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-795"><a href="#cb68-795" aria-hidden="true" tabindex="-1"></a>You might then compare black vs. white, etc., by calculating differences or ratios in the posterior draws.</span>
<span id="cb68-796"><a href="#cb68-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-799"><a href="#cb68-799" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-800"><a href="#cb68-800" aria-hidden="true" tabindex="-1"></a>posterior_ratios <span class="ot">&lt;-</span> posterior <span class="sc">%&gt;%</span></span>
<span id="cb68-801"><a href="#cb68-801" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb68-802"><a href="#cb68-802" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> <span class="fu">c</span>(.chain, .iteration, .draw),  <span class="co"># these 3 columns identify each draw</span></span>
<span id="cb68-803"><a href="#cb68-803" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> e,                          <span class="co"># which column to pivot on</span></span>
<span id="cb68-804"><a href="#cb68-804" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> rate,                      <span class="co"># which column holds the values</span></span>
<span id="cb68-805"><a href="#cb68-805" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_prefix =</span> <span class="st">"eth_"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb68-806"><a href="#cb68-806" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb68-807"><a href="#cb68-807" aria-hidden="true" tabindex="-1"></a>    <span class="at">black_vs_white =</span> eth_1 <span class="sc">/</span> eth_3,</span>
<span id="cb68-808"><a href="#cb68-808" aria-hidden="true" tabindex="-1"></a>    <span class="at">hisp_vs_white  =</span> eth_2 <span class="sc">/</span> eth_3) <span class="sc">%&gt;%</span></span>
<span id="cb68-809"><a href="#cb68-809" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Pivot longer so each ratio is in its own row</span></span>
<span id="cb68-810"><a href="#cb68-810" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb68-811"><a href="#cb68-811" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(black_vs_white, hisp_vs_white),</span>
<span id="cb68-812"><a href="#cb68-812" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"contrast"</span>,</span>
<span id="cb68-813"><a href="#cb68-813" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"ratio"</span></span>
<span id="cb68-814"><a href="#cb68-814" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb68-815"><a href="#cb68-815" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Summarize with mean_hdi -&gt; returns columns .mean, .lower, .upper</span></span>
<span id="cb68-816"><a href="#cb68-816" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(contrast) <span class="sc">%&gt;%</span></span>
<span id="cb68-817"><a href="#cb68-817" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean_hdi</span>(ratio, <span class="at">.width =</span> <span class="fl">0.95</span>)</span>
<span id="cb68-818"><a href="#cb68-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-819"><a href="#cb68-819" aria-hidden="true" tabindex="-1"></a>posterior_ratios</span>
<span id="cb68-820"><a href="#cb68-820" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-821"><a href="#cb68-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-822"><a href="#cb68-822" aria-hidden="true" tabindex="-1"></a>This gives an estimate of how many times more likely stops of black (or hispanic) are relative to stops of white people, after controlling for arrests, precinct differences, and overdispersion.</span>
<span id="cb68-823"><a href="#cb68-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-824"><a href="#cb68-824" aria-hidden="true" tabindex="-1"></a>To visualise this with a plot:</span>
<span id="cb68-825"><a href="#cb68-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-828"><a href="#cb68-828" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-829"><a href="#cb68-829" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: 'center'</span></span>
<span id="cb68-830"><a href="#cb68-830" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap-location: margin</span></span>
<span id="cb68-831"><a href="#cb68-831" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 2.5</span></span>
<span id="cb68-832"><a href="#cb68-832" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 3</span></span>
<span id="cb68-833"><a href="#cb68-833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-834"><a href="#cb68-834" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(posterior_ratios, <span class="fu">aes</span>(<span class="at">x =</span> contrast, <span class="at">y =</span> ratio)) <span class="sc">+</span></span>
<span id="cb68-835"><a href="#cb68-835" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size=</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb68-836"><a href="#cb68-836" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="dv">1</span>, <span class="at">lty=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb68-837"><a href="#cb68-837" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> .lower, <span class="at">ymax =</span> .upper), <span class="at">width =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb68-838"><a href="#cb68-838" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb68-839"><a href="#cb68-839" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb68-840"><a href="#cb68-840" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Ratio relative to White"</span>,</span>
<span id="cb68-841"><a href="#cb68-841" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Ethnicity vs. White Stop Ratios"</span>,</span>
<span id="cb68-842"><a href="#cb68-842" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Points = posterior means; bars = 95% HDI"</span></span>
<span id="cb68-843"><a href="#cb68-843" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb68-844"><a href="#cb68-844" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-845"><a href="#cb68-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-846"><a href="#cb68-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-847"><a href="#cb68-847" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 5) Prior predictive check</span></span>
<span id="cb68-848"><a href="#cb68-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-849"><a href="#cb68-849" aria-hidden="true" tabindex="-1"></a>To check that the prior is sensible, it can be useful to simulate the _prior predictive distribution_ and compare it to the actual, observed data. This is defined as </span>
<span id="cb68-850"><a href="#cb68-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-851"><a href="#cb68-851" aria-hidden="true" tabindex="-1"></a>$$p(y) =  \int p(y\mid \Theta) \ p( \Theta) d\Theta $$</span>
<span id="cb68-852"><a href="#cb68-852" aria-hidden="true" tabindex="-1"></a>where $\Theta$ indicate the parameters, in this case $\Theta = \left<span class="sc">\{</span> \alpha, \sigma_{\beta}, \sigma_{\epsilon} \right<span class="sc">\}</span>$.</span>
<span id="cb68-853"><a href="#cb68-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-854"><a href="#cb68-854" aria-hidden="true" tabindex="-1"></a>In other words, we resample both observation-level over dispersion values, the precinct-specific random intercepts, as well as the poisson observations. This gives us a way to estimate the prior predictive distribution, which we can then compare to the actual data. Ideally, the observed data should lie well within the prior-predictive distribution, suggesting that our priors were adequate and not too informative. </span>
<span id="cb68-855"><a href="#cb68-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-858"><a href="#cb68-858" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-859"><a href="#cb68-859" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(d)</span>
<span id="cb68-860"><a href="#cb68-860" aria-hidden="true" tabindex="-1"></a>n_eth <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(d<span class="sc">$</span>eth))</span>
<span id="cb68-861"><a href="#cb68-861" aria-hidden="true" tabindex="-1"></a>n_prec <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(d<span class="sc">$</span>precinct))</span>
<span id="cb68-862"><a href="#cb68-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-863"><a href="#cb68-863" aria-hidden="true" tabindex="-1"></a><span class="co"># Decide how many draws from the prior to simulate</span></span>
<span id="cb68-864"><a href="#cb68-864" aria-hidden="true" tabindex="-1"></a>n_sims <span class="ot">&lt;-</span> <span class="dv">500</span>  </span>
<span id="cb68-865"><a href="#cb68-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-866"><a href="#cb68-866" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll store all simulated Y values in a single big vector</span></span>
<span id="cb68-867"><a href="#cb68-867" aria-hidden="true" tabindex="-1"></a><span class="co"># so we can compare them to the observed distribution</span></span>
<span id="cb68-868"><a href="#cb68-868" aria-hidden="true" tabindex="-1"></a>all_prior_stops <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="dv">0</span>)</span>
<span id="cb68-869"><a href="#cb68-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-870"><a href="#cb68-870" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)  <span class="co"># reproducibility</span></span>
<span id="cb68-871"><a href="#cb68-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-872"><a href="#cb68-872" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_sims) {</span>
<span id="cb68-873"><a href="#cb68-873" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-874"><a href="#cb68-874" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1) Sample the parameters from their priors</span></span>
<span id="cb68-875"><a href="#cb68-875" aria-hidden="true" tabindex="-1"></a>  alpha_draw <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_eth, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">5</span>) <span class="co"># alpha: one for each ethnicity</span></span>
<span id="cb68-876"><a href="#cb68-876" aria-hidden="true" tabindex="-1"></a>  sigma_beta_draw <span class="ot">&lt;-</span> <span class="fu">rexp</span>(<span class="dv">1</span>, <span class="at">rate =</span> <span class="dv">1</span>)</span>
<span id="cb68-877"><a href="#cb68-877" aria-hidden="true" tabindex="-1"></a>  beta_raw_draw <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_prec, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb68-878"><a href="#cb68-878" aria-hidden="true" tabindex="-1"></a>  beta_draw <span class="ot">&lt;-</span> sigma_beta_draw <span class="sc">*</span> beta_raw_draw</span>
<span id="cb68-879"><a href="#cb68-879" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-880"><a href="#cb68-880" aria-hidden="true" tabindex="-1"></a>  sigma_eps_draw <span class="ot">&lt;-</span> <span class="fu">rexp</span>(<span class="dv">1</span>, <span class="at">rate =</span> <span class="dv">1</span>)          <span class="co"># Overdispersion</span></span>
<span id="cb68-881"><a href="#cb68-881" aria-hidden="true" tabindex="-1"></a>  eps_raw_draw <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb68-882"><a href="#cb68-882" aria-hidden="true" tabindex="-1"></a>  eps_draw <span class="ot">&lt;-</span> sigma_eps_draw <span class="sc">*</span> eps_raw_draw</span>
<span id="cb68-883"><a href="#cb68-883" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-884"><a href="#cb68-884" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2) Generate y (stops) from Poisson for each observation i</span></span>
<span id="cb68-885"><a href="#cb68-885" aria-hidden="true" tabindex="-1"></a>  past_arrests_offset <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(d<span class="sc">$</span>past.arrests <span class="sc">==</span> <span class="dv">0</span>, <span class="fl">0.5</span>, d<span class="sc">$</span>past.arrests)</span>
<span id="cb68-886"><a href="#cb68-886" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-887"><a href="#cb68-887" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute the linear predictor for each row i</span></span>
<span id="cb68-888"><a href="#cb68-888" aria-hidden="true" tabindex="-1"></a>  lambda_vec <span class="ot">&lt;-</span> <span class="fu">numeric</span>(N)</span>
<span id="cb68-889"><a href="#cb68-889" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(N)) {</span>
<span id="cb68-890"><a href="#cb68-890" aria-hidden="true" tabindex="-1"></a>    e <span class="ot">&lt;-</span> d<span class="sc">$</span>eth[i]</span>
<span id="cb68-891"><a href="#cb68-891" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> d<span class="sc">$</span>precinct[i]</span>
<span id="cb68-892"><a href="#cb68-892" aria-hidden="true" tabindex="-1"></a>    lambda_vec[i] <span class="ot">&lt;-</span> alpha_draw[e] <span class="sc">+</span> beta_draw[p] <span class="sc">+</span> eps_draw[i]</span>
<span id="cb68-893"><a href="#cb68-893" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb68-894"><a href="#cb68-894" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-895"><a href="#cb68-895" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Poisson means</span></span>
<span id="cb68-896"><a href="#cb68-896" aria-hidden="true" tabindex="-1"></a>  mu_vec <span class="ot">&lt;-</span> past_arrests_offset <span class="sc">*</span> (<span class="dv">15</span><span class="sc">/</span><span class="dv">12</span>) <span class="sc">*</span> <span class="fu">exp</span>(lambda_vec)</span>
<span id="cb68-897"><a href="#cb68-897" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-898"><a href="#cb68-898" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sample from Poisson</span></span>
<span id="cb68-899"><a href="#cb68-899" aria-hidden="true" tabindex="-1"></a>  y_sim <span class="ot">&lt;-</span> <span class="fu">rpois</span>(N, mu_vec)</span>
<span id="cb68-900"><a href="#cb68-900" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-901"><a href="#cb68-901" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3) Store in a big vector for later comparison</span></span>
<span id="cb68-902"><a href="#cb68-902" aria-hidden="true" tabindex="-1"></a>  all_prior_stops <span class="ot">&lt;-</span> <span class="fu">c</span>(all_prior_stops, y_sim)</span>
<span id="cb68-903"><a href="#cb68-903" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-904"><a href="#cb68-904" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-905"><a href="#cb68-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-906"><a href="#cb68-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-907"><a href="#cb68-907" aria-hidden="true" tabindex="-1"></a>Now we have the number of 'stops' simulated from the prior, and we can compare with the empirical distribution:</span>
<span id="cb68-908"><a href="#cb68-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-911"><a href="#cb68-911" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-912"><a href="#cb68-912" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: 'center'</span></span>
<span id="cb68-913"><a href="#cb68-913" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap-location: margin</span></span>
<span id="cb68-914"><a href="#cb68-914" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 6</span></span>
<span id="cb68-915"><a href="#cb68-915" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 3</span></span>
<span id="cb68-916"><a href="#cb68-916" aria-hidden="true" tabindex="-1"></a>observed_stops <span class="ot">&lt;-</span> d<span class="sc">$</span>stops</span>
<span id="cb68-917"><a href="#cb68-917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-918"><a href="#cb68-918" aria-hidden="true" tabindex="-1"></a>df_plot <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb68-919"><a href="#cb68-919" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="fu">c</span>((observed_stops ), (all_prior_stops )),</span>
<span id="cb68-920"><a href="#cb68-920" aria-hidden="true" tabindex="-1"></a>  <span class="at">type  =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Empirical"</span>, <span class="st">"Prior"</span>), <span class="fu">c</span>(<span class="fu">length</span>(observed_stops), <span class="fu">length</span>(all_prior_stops))))</span>
<span id="cb68-921"><a href="#cb68-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-922"><a href="#cb68-922" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot densities</span></span>
<span id="cb68-923"><a href="#cb68-923" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_plot, <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> type)) <span class="sc">+</span></span>
<span id="cb68-924"><a href="#cb68-924" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb68-925"><a href="#cb68-925" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"stops"</span>, <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb68-926"><a href="#cb68-926" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Prior Predictive vs. Empirical Distribution (log scale)"</span>,</span>
<span id="cb68-927"><a href="#cb68-927" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Data Source"</span></span>
<span id="cb68-928"><a href="#cb68-928" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb68-929"><a href="#cb68-929" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb68-930"><a href="#cb68-930" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>()</span>
<span id="cb68-931"><a href="#cb68-931" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-932"><a href="#cb68-932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-933"><a href="#cb68-933" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 6) Posterior predictive check</span></span>
<span id="cb68-934"><a href="#cb68-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-935"><a href="#cb68-935" aria-hidden="true" tabindex="-1"></a>We can use a similar approach to compare the posterior distribution to the observed data. That is, we are comparing the data with the _posterior predictive distribution_</span>
<span id="cb68-936"><a href="#cb68-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-937"><a href="#cb68-937" aria-hidden="true" tabindex="-1"></a>$$p(y^{\text{rep}} \mid y) =  \int p(y^{\text{rep}} \mid \Theta) \ p( \Theta \mid y) d\Theta $$</span>
<span id="cb68-938"><a href="#cb68-938" aria-hidden="true" tabindex="-1"></a>It may be useful to not resample all of the random effects; in this case for example I decided to hold fixed the precinct-specific random intercepts, and to resample only the observation-level overdispersion values. </span>
<span id="cb68-939"><a href="#cb68-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-940"><a href="#cb68-940" aria-hidden="true" tabindex="-1"></a>This allows me to compute a predictive interval for the stop rate in each precinct, which allows more granularity in the comparison between model and data.</span>
<span id="cb68-941"><a href="#cb68-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-942"><a href="#cb68-942" aria-hidden="true" tabindex="-1"></a>There are different ways to do this, either via R (as in the prior predictive check above) or we can take advantage of the generated quantities block in Stan, and add the following to our model code:</span>
<span id="cb68-943"><a href="#cb68-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-944"><a href="#cb68-944" aria-hidden="true" tabindex="-1"></a><span class="in">```{.stan}</span></span>
<span id="cb68-945"><a href="#cb68-945" aria-hidden="true" tabindex="-1"></a><span class="in">generated quantities {</span></span>
<span id="cb68-946"><a href="#cb68-946" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[N] log_lik; // Log-likelihood for each observation (for LOO-CV)</span></span>
<span id="cb68-947"><a href="#cb68-947" aria-hidden="true" tabindex="-1"></a><span class="in">  real eps_rep; // random effects observation-level overdipersion</span></span>
<span id="cb68-948"><a href="#cb68-948" aria-hidden="true" tabindex="-1"></a><span class="in">  array[N] int y_rep;</span></span>
<span id="cb68-949"><a href="#cb68-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-950"><a href="#cb68-950" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i in 1:N) {</span></span>
<span id="cb68-951"><a href="#cb68-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-952"><a href="#cb68-952" aria-hidden="true" tabindex="-1"></a><span class="in">    // Compute log-likelihood for observed data    </span></span>
<span id="cb68-953"><a href="#cb68-953" aria-hidden="true" tabindex="-1"></a><span class="in">    log_lik[i] = poisson_lpmf(y[i] | past_arrests[i] * (15.0 / 12.0) * exp(alpha[eth[i]] + beta[precinct[i]] + eps[i]));</span></span>
<span id="cb68-954"><a href="#cb68-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-955"><a href="#cb68-955" aria-hidden="true" tabindex="-1"></a><span class="in">    // Simulate replicated data from posterior predictive distribution</span></span>
<span id="cb68-956"><a href="#cb68-956" aria-hidden="true" tabindex="-1"></a><span class="in">    eps_rep = sigma_eps * normal_rng(0, 1);</span></span>
<span id="cb68-957"><a href="#cb68-957" aria-hidden="true" tabindex="-1"></a><span class="in">    y_rep[i] = poisson_rng(past_arrests[i] * (15.0 / 12.0) * exp(alpha[eth[i]] + beta[precinct[i]] + eps_rep));</span></span>
<span id="cb68-958"><a href="#cb68-958" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb68-959"><a href="#cb68-959" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb68-960"><a href="#cb68-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-961"><a href="#cb68-961" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-962"><a href="#cb68-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-963"><a href="#cb68-963" aria-hidden="true" tabindex="-1"></a>Assuming the code is saved in the file <span class="in">`stan_code/overdispersed_poisson_PPC.stan`</span>, we then need to re-do the sampling:</span>
<span id="cb68-964"><a href="#cb68-964" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-965"><a href="#cb68-965" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb68-966"><a href="#cb68-966" aria-hidden="true" tabindex="-1"></a><span class="in">fit &lt;- stan(</span></span>
<span id="cb68-967"><a href="#cb68-967" aria-hidden="true" tabindex="-1"></a><span class="in">  file = "stan_code/overdispersed_poisson_PPC.stan",</span></span>
<span id="cb68-968"><a href="#cb68-968" aria-hidden="true" tabindex="-1"></a><span class="in">  data = stan_data,</span></span>
<span id="cb68-969"><a href="#cb68-969" aria-hidden="true" tabindex="-1"></a><span class="in">  iter = 2000,</span></span>
<span id="cb68-970"><a href="#cb68-970" aria-hidden="true" tabindex="-1"></a><span class="in">  chains = 4,</span></span>
<span id="cb68-971"><a href="#cb68-971" aria-hidden="true" tabindex="-1"></a><span class="in">  cores = 4)</span></span>
<span id="cb68-972"><a href="#cb68-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-973"><a href="#cb68-973" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-974"><a href="#cb68-974" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=FALSE}</span></span>
<span id="cb68-975"><a href="#cb68-975" aria-hidden="true" tabindex="-1"></a><span class="in">fit &lt;- readRDS("outputs/police_stops_PPC.RDS")</span></span>
<span id="cb68-976"><a href="#cb68-976" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-977"><a href="#cb68-977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-978"><a href="#cb68-978" aria-hidden="true" tabindex="-1"></a>Once we have run that, we can extract the posterior predictive for each precinct, and plot them alongside the observed.</span>
<span id="cb68-979"><a href="#cb68-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-980"><a href="#cb68-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-983"><a href="#cb68-983" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-984"><a href="#cb68-984" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: 'center'</span></span>
<span id="cb68-985"><a href="#cb68-985" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap-location: margin</span></span>
<span id="cb68-986"><a href="#cb68-986" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 5</span></span>
<span id="cb68-987"><a href="#cb68-987" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb68-988"><a href="#cb68-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-989"><a href="#cb68-989" aria-hidden="true" tabindex="-1"></a><span class="co"># Map observation index -&gt; precinct</span></span>
<span id="cb68-990"><a href="#cb68-990" aria-hidden="true" tabindex="-1"></a>precinct_idx <span class="ot">&lt;-</span> d<span class="sc">$</span>precinct  <span class="co"># length N</span></span>
<span id="cb68-991"><a href="#cb68-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-992"><a href="#cb68-992" aria-hidden="true" tabindex="-1"></a><span class="co"># Observed precinct totals</span></span>
<span id="cb68-993"><a href="#cb68-993" aria-hidden="true" tabindex="-1"></a>obs_totals <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb68-994"><a href="#cb68-994" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(precinct) <span class="sc">%&gt;%</span></span>
<span id="cb68-995"><a href="#cb68-995" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">obs_total =</span> <span class="fu">sum</span>(stops), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb68-996"><a href="#cb68-996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-997"><a href="#cb68-997" aria-hidden="true" tabindex="-1"></a><span class="co"># Exposure per precinct (for *rates* option)</span></span>
<span id="cb68-998"><a href="#cb68-998" aria-hidden="true" tabindex="-1"></a>exposure_by_precinct <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb68-999"><a href="#cb68-999" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">expo =</span> past.arrests <span class="sc">*</span> (<span class="dv">15</span><span class="sc">/</span><span class="dv">12</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb68-1000"><a href="#cb68-1000" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(precinct) <span class="sc">%&gt;%</span></span>
<span id="cb68-1001"><a href="#cb68-1001" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">exposure =</span> <span class="fu">sum</span>(expo), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb68-1002"><a href="#cb68-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1003"><a href="#cb68-1003" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Extract posterior predictive draws for y_rep[i]</span></span>
<span id="cb68-1004"><a href="#cb68-1004" aria-hidden="true" tabindex="-1"></a>yrep_long <span class="ot">&lt;-</span> fit <span class="sc">%&gt;%</span></span>
<span id="cb68-1005"><a href="#cb68-1005" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(y_rep[i]) <span class="sc">%&gt;%</span></span>
<span id="cb68-1006"><a href="#cb68-1006" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">precinct =</span> precinct_idx[i])</span>
<span id="cb68-1007"><a href="#cb68-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1008"><a href="#cb68-1008" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Aggregate to precinct totals per draw</span></span>
<span id="cb68-1009"><a href="#cb68-1009" aria-hidden="true" tabindex="-1"></a>ppc_totals <span class="ot">&lt;-</span> yrep_long <span class="sc">%&gt;%</span></span>
<span id="cb68-1010"><a href="#cb68-1010" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(.draw, precinct) <span class="sc">%&gt;%</span></span>
<span id="cb68-1011"><a href="#cb68-1011" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">rep_total =</span> <span class="fu">sum</span>(y_rep), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb68-1012"><a href="#cb68-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1013"><a href="#cb68-1013" aria-hidden="true" tabindex="-1"></a><span class="co"># 3a) (Totals) Summarise mean and 95% CI per precinct</span></span>
<span id="cb68-1014"><a href="#cb68-1014" aria-hidden="true" tabindex="-1"></a>ppc_totals_sum <span class="ot">&lt;-</span> ppc_totals <span class="sc">%&gt;%</span></span>
<span id="cb68-1015"><a href="#cb68-1015" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(precinct) <span class="sc">%&gt;%</span></span>
<span id="cb68-1016"><a href="#cb68-1016" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean_qi</span>(rep_total, <span class="at">.width =</span> <span class="fl">0.95</span>) <span class="sc">%&gt;%</span>    <span class="co"># columns: rep_total, .lower, .upper</span></span>
<span id="cb68-1017"><a href="#cb68-1017" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb68-1018"><a href="#cb68-1018" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(obs_totals, <span class="at">by =</span> <span class="st">"precinct"</span>)</span>
<span id="cb68-1019"><a href="#cb68-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1020"><a href="#cb68-1020" aria-hidden="true" tabindex="-1"></a>ppc_totals_sum_ord <span class="ot">&lt;-</span> ppc_totals_sum <span class="sc">%&gt;%</span></span>
<span id="cb68-1021"><a href="#cb68-1021" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">precinct_ord =</span> <span class="fu">fct_reorder</span>(<span class="fu">factor</span>(precinct), obs_total))</span>
<span id="cb68-1022"><a href="#cb68-1022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1023"><a href="#cb68-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1024"><a href="#cb68-1024" aria-hidden="true" tabindex="-1"></a><span class="co"># 4a) Plot totals: posterior predictive (mean + 95% CI) vs observed</span></span>
<span id="cb68-1025"><a href="#cb68-1025" aria-hidden="true" tabindex="-1"></a>ppc_totals_sum <span class="sc">%&gt;%</span></span>
<span id="cb68-1026"><a href="#cb68-1026" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">precinct =</span> <span class="fu">fct_reorder</span>(<span class="fu">factor</span>(precinct), obs_total)) <span class="sc">%&gt;%</span></span>
<span id="cb68-1027"><a href="#cb68-1027" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(precinct), <span class="at">y =</span> rep_total)) <span class="sc">+</span></span>
<span id="cb68-1028"><a href="#cb68-1028" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> .lower, <span class="at">ymax =</span> .upper), <span class="at">color=</span><span class="st">"dark grey"</span>) <span class="sc">+</span></span>
<span id="cb68-1029"><a href="#cb68-1029" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> obs_total), <span class="at">shape =</span> <span class="dv">4</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.15</span>)) <span class="sc">+</span></span>
<span id="cb68-1030"><a href="#cb68-1030" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Precinct"</span>, <span class="at">y =</span> <span class="st">"Total stops"</span>,</span>
<span id="cb68-1031"><a href="#cb68-1031" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Posterior predictive totals by precinct"</span>,</span>
<span id="cb68-1032"><a href="#cb68-1032" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Points = posterior mean (CI = 95%), X = observed total"</span>) <span class="sc">+</span></span>
<span id="cb68-1033"><a href="#cb68-1033" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb68-1034"><a href="#cb68-1034" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb68-1035"><a href="#cb68-1035" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-1036"><a href="#cb68-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1037"><a href="#cb68-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1038"><a href="#cb68-1038" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>